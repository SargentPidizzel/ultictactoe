<!DOCTYPE html>
<html lang="de">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Ultimate Tic-Tac-Toe – Tailwind</title>
    <!-- Tailwind via CDN für Demo. In Produktion gern lokal einbinden. -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Sanfte Übergänge für Statusänderungen */
        .smooth {
            transition: all 180ms ease-in-out;
        }
    </style>
</head>

<body class="min-h-screen bg-[#12181B] text-slate-100 antialiased">
    {% include 'navbar.html' %}

    <div class="mx-auto max-w-3xl px-4 py-8">
       <div class="mb-6 rounded-xl bg-white/5 ring-1 ring-white/10 shadow-md">
          <!-- Header mit Lobby Code + Buttons -->
          <header class="flex items-center justify-between border-b border-white/10 px-5 py-3">
            <h1 class="text-base font-medium text-white">
              Lobby Code: <span class="font-mono text-blue-400">{{ room_code }}</span>
            </h1>

            <div class="flex gap-2">
              <button id="resetBtn"
                class="rounded-lg border border-white/20 bg-transparent px-3 py-2 text-sm font-medium text-white hover:bg-white/10 active:bg-white/15 transition">
                Neu starten
              </button>
              <button id="helpBtn"
                class="rounded-lg border border-white/20 bg-transparent px-3 py-2 text-sm font-medium text-white hover:bg-white/10 active:bg-white/15 transition"
                type="button" onclick="document.getElementById('rulesDialog').showModal()">
                Regeln
              </button>
            </div>
          </header>

          <!-- Spielerinfos -->
          <div id="players" class="flex justify-between px-5 py-3 text-sm text-white">
            <div id="player1" class="text-left">
              Du: <br>
             <span id="your_name"></span> (<span id="symbol_you" class="font-semibold text-red-400"></span>)
            </div>

            <div id="status" class="text-center font-medium">
              Spieler <span class="font-semibold" id="playerSpan">X</span> ist dran.
            </div>

            <div id="player2" class="text-right">
              Gegner: <span id="symbol_oponent" class="font-semibold text-green-400"></span><br>
              Name: <span id="oponent_name"></span>
            </div>
          </div>
        </div>

        <!-- Statusleiste -->
        <!-- <div id="status" class="mb-5 rounded-xl bg-white/5 ring-1 ring-white/10 p-3 text-sm">
            Spieler <span class="font-semibold" id="playerSpan">X</span> ist dran.
        </div> -->

        <!-- Spielfeld: 3x3 Großfelder, jedes enthält ein 3x3 Kleinraster -->
        <!-- Spielfeld: 3x3 Großfelder, jedes enthält ein 3x3 Kleinraster -->
        <div id="board"
            class="mx-auto aspect-square w-full max-w-2xl grid grid-cols-3 gap-3 p-3 rounded-2xl bg-[#0F1518]/40 ring-1 ring-white/10 shadow-2xl backdrop-blur-sm">

            <!-- Großfeld 0 -->
            <div id="field_0"
                class="grid grid-cols-3 gap-1 aspect-square rounded-2xl p-1 bg-gradient-to-br from-[#1C2529] to-[#11171A] ring-2 ring-white shadow-xl">
                <div id="0_0" class="aspect-square rounded-lg border border-white/20 bg-[#2A3439] small-field">
                </div>
                <div id="0_1" class="aspect-square rounded-lg border border-white/20 bg-[#2A3439] small-field">
                </div>
                <div id="0_2" class="aspect-square rounded-lg border border-white/20 bg-[#2A3439] small-field">
                </div>
                <div id="0_3" class="aspect-square rounded-lg border border-white/20 bg-[#2A3439] small-field">
                </div>
                <div id="0_4" class="aspect-square rounded-lg border border-white/20 bg-[#2A3439] small-field">
                </div>
                <div id="0_5" class="aspect-square rounded-lg border border-white/20 bg-[#2A3439] small-field">
                </div>
                <div id="0_6" class="aspect-square rounded-lg border border-white/20 bg-[#2A3439] small-field">
                </div>
                <div id="0_7" class="aspect-square rounded-lg border border-white/20 bg-[#2A3439] small-field">
                </div>
                <div id="0_8" class="aspect-square rounded-lg border border-white/20 bg-[#2A3439] small-field">
                </div>
            </div>

            <!-- Großfeld 1 -->
            <div id="field_1"
                class="grid grid-cols-3 gap-1 aspect-square rounded-2xl p-1 bg-gradient-to-br from-[#1C2529] to-[#11171A] ring-2 ring-white shadow-xl">
                <div id="1_0" class="aspect-square rounded-lg border border-white/20 bg-[#2A3439] small-field">
                </div>
                <div id="1_1" class="aspect-square rounded-lg border border-white/20 bg-[#2A3439] small-field">
                </div>
                <div id="1_2" class="aspect-square rounded-lg border border-white/20 bg-[#2A3439] small-field">
                </div>
                <div id="1_3" class="aspect-square rounded-lg border border-white/20 bg-[#2A3439] small-field">
                </div>
                <div id="1_4" class="aspect-square rounded-lg border border-white/20 bg-[#2A3439] small-field">
                </div>
                <div id="1_5" class="aspect-square rounded-lg border border-white/20 bg-[#2A3439] small-field">
                </div>
                <div id="1_6" class="aspect-square rounded-lg border border-white/20 bg-[#2A3439] small-field">
                </div>
                <div id="1_7" class="aspect-square rounded-lg border border-white/20 bg-[#2A3439] small-field">
                </div>
                <div id="1_8" class="aspect-square rounded-lg border border-white/20 bg-[#2A3439] small-field">
                </div>
            </div>

            <!-- Großfeld 2 -->
            <div id="field_2"
                class="grid grid-cols-3 gap-1 aspect-square rounded-2xl p-1 bg-gradient-to-br from-[#1C2529] to-[#11171A] ring-2 ring-white shadow-xl">
                <div id="2_0" class="aspect-square rounded-lg border border-white/20 bg-[#2A3439] small-field">
                </div>
                <div id="2_1" class="aspect-square rounded-lg border border-white/20 bg-[#2A3439] small-field">
                </div>
                <div id="2_2" class="aspect-square rounded-lg border border-white/20 bg-[#2A3439] small-field">
                </div>
                <div id="2_3" class="aspect-square rounded-lg border border-white/20 bg-[#2A3439] small-field">
                </div>
                <div id="2_4" class="aspect-square rounded-lg border border-white/20 bg-[#2A3439] small-field">
                </div>
                <div id="2_5" class="aspect-square rounded-lg border border-white/20 bg-[#2A3439] small-field">
                </div>
                <div id="2_6" class="aspect-square rounded-lg border border-white/20 bg-[#2A3439] small-field">
                </div>
                <div id="2_7" class="aspect-square rounded-lg border border-white/20 bg-[#2A3439] small-field">
                </div>
                <div id="2_8" class="aspect-square rounded-lg border border-white/20 bg-[#2A3439] small-field">
                </div>
            </div>

            <!-- Großfeld 3 -->
            <div id="field_3"
                class="grid grid-cols-3 gap-1 aspect-square rounded-2xl p-1 bg-gradient-to-br from-[#1C2529] to-[#11171A] ring-2 ring-white shadow-xl">
                <div id="3_0" class="aspect-square rounded-lg border border-white/20 bg-[#2A3439] small-field">
                </div>
                <div id="3_1" class="aspect-square rounded-lg border border-white/20 bg-[#2A3439] small-field">
                </div>
                <div id="3_2" class="aspect-square rounded-lg border border-white/20 bg-[#2A3439] small-field">
                </div>
                <div id="3_3" class="aspect-square rounded-lg border border-white/20 bg-[#2A3439] small-field">
                </div>
                <div id="3_4" class="aspect-square rounded-lg border border-white/20 bg-[#2A3439] small-field">
                </div>
                <div id="3_5" class="aspect-square rounded-lg border border-white/20 bg-[#2A3439] small-field">
                </div>
                <div id="3_6" class="aspect-square rounded-lg border border-white/20 bg-[#2A3439] small-field">
                </div>
                <div id="3_7" class="aspect-square rounded-lg border border-white/20 bg-[#2A3439] small-field">
                </div>
                <div id="3_8" class="aspect-square rounded-lg border border-white/20 bg-[#2A3439] small-field">
                </div>
            </div>

            <!-- Großfeld 4 -->
            <div id="field_4"
                class="grid grid-cols-3 gap-1 aspect-square rounded-2xl p-1 bg-gradient-to-br from-[#1C2529] to-[#11171A] ring-2 ring-white shadow-xl">
                <div id="4_0" class="aspect-square rounded-lg border border-white/20 bg-[#2A3439] small-field">
                </div>
                <div id="4_1" class="aspect-square rounded-lg border border-white/20 bg-[#2A3439] small-field">
                </div>
                <div id="4_2" class="aspect-square rounded-lg border border-white/20 bg-[#2A3439] small-field">
                </div>
                <div id="4_3" class="aspect-square rounded-lg border border-white/20 bg-[#2A3439] small-field">
                </div>
                <div id="4_4" class="aspect-square rounded-lg border border-white/20 bg-[#2A3439] small-field">
                </div>
                <div id="4_5" class="aspect-square rounded-lg border border-white/20 bg-[#2A3439] small-field">
                </div>
                <div id="4_6" class="aspect-square rounded-lg border border-white/20 bg-[#2A3439] small-field">
                </div>
                <div id="4_7" class="aspect-square rounded-lg border border-white/20 bg-[#2A3439] small-field">
                </div>
                <div id="4_8" class="aspect-square rounded-lg border border-white/20 bg-[#2A3439] small-field">
                </div>
            </div>

            <!-- Großfeld 5 -->
            <div id="field_5"
                class="grid grid-cols-3 gap-1 aspect-square rounded-2xl p-1 bg-gradient-to-br from-[#1C2529] to-[#11171A] ring-2 ring-white shadow-xl">
                <div id="5_0" class="aspect-square rounded-lg border border-white/20 bg-[#2A3439] small-field">
                </div>
                <div id="5_1" class="aspect-square rounded-lg border border-white/20 bg-[#2A3439] small-field">
                </div>
                <div id="5_2" class="aspect-square rounded-lg border border-white/20 bg-[#2A3439] small-field">
                </div>
                <div id="5_3" class="aspect-square rounded-lg border border-white/20 bg-[#2A3439] small-field">
                </div>
                <div id="5_4" class="aspect-square rounded-lg border border-white/20 bg-[#2A3439] small-field">
                </div>
                <div id="5_5" class="aspect-square rounded-lg border border-white/20 bg-[#2A3439] small-field">
                </div>
                <div id="5_6" class="aspect-square rounded-lg border border-white/20 bg-[#2A3439] small-field">
                </div>
                <div id="5_7" class="aspect-square rounded-lg border border-white/20 bg-[#2A3439] small-field">
                </div>
                <div id="5_8" class="aspect-square rounded-lg border border-white/20 bg-[#2A3439] small-field">
                </div>
            </div>

            <!-- Großfeld 6 -->
            <div id="field_6"
                class="grid grid-cols-3 gap-1 aspect-square rounded-2xl p-1 bg-gradient-to-br from-[#1C2529] to-[#11171A] ring-2 ring-white shadow-xl">
                <div id="6_0" class="aspect-square rounded-lg border border-white/20 bg-[#2A3439] small-field">
                </div>
                <div id="6_1" class="aspect-square rounded-lg border border-white/20 bg-[#2A3439] small-field">
                </div>
                <div id="6_2" class="aspect-square rounded-lg border border-white/20 bg-[#2A3439] small-field">
                </div>
                <div id="6_3" class="aspect-square rounded-lg border border-white/20 bg-[#2A3439] small-field">
                </div>
                <div id="6_4" class="aspect-square rounded-lg border border-white/20 bg-[#2A3439] small-field">
                </div>
                <div id="6_5" class="aspect-square rounded-lg border border-white/20 bg-[#2A3439] small-field">
                </div>
                <div id="6_6" class="aspect-square rounded-lg border border-white/20 bg-[#2A3439] small-field">
                </div>
                <div id="6_7" class="aspect-square rounded-lg border border-white/20 bg-[#2A3439] small-field">
                </div>
                <div id="6_8" class="aspect-square rounded-lg border border-white/20 bg-[#2A3439] small-field">
                </div>
            </div>

            <!-- Großfeld 7 -->
            <div id="field_7"
                class="grid grid-cols-3 gap-1 aspect-square rounded-2xl p-1 bg-gradient-to-br from-[#1C2529] to-[#11171A] ring-2 ring-white shadow-xl">
                <div id="7_0" class="aspect-square rounded-lg border border-white/20 bg-[#2A3439] small-field">
                </div>
                <div id="7_1" class="aspect-square rounded-lg border border-white/20 bg-[#2A3439] small-field">
                </div>
                <div id="7_2" class="aspect-square rounded-lg border border-white/20 bg-[#2A3439] small-field">
                </div>
                <div id="7_3" class="aspect-square rounded-lg border border-white/20 bg-[#2A3439] small-field">
                </div>
                <div id="7_4" class="aspect-square rounded-lg border border-white/20 bg-[#2A3439] small-field">
                </div>
                <div id="7_5" class="aspect-square rounded-lg border border-white/20 bg-[#2A3439] small-field">
                </div>
                <div id="7_6" class="aspect-square rounded-lg border border-white/20 bg-[#2A3439] small-field">
                </div>
                <div id="7_7" class="aspect-square rounded-lg border border-white/20 bg-[#2A3439] small-field">
                </div>
                <div id="7_8" class="aspect-square rounded-lg border border-white/20 bg-[#2A3439] small-field">
                </div>
            </div>

            <!-- Großfeld 8 -->
            <div id="field_8"
                class="grid grid-cols-3 gap-1 aspect-square rounded-2xl p-1 bg-gradient-to-br from-[#1C2529] to-[#11171A] ring-2 ring-white shadow-xl">
                <div id="8_0" class="aspect-square rounded-lg border border-white/20 bg-[#2A3439] small-field">
                </div>
                <div id="8_1" class="aspect-square rounded-lg border border-white/20 bg-[#2A3439] small-field">
                </div>
                <div id="8_2" class="aspect-square rounded-lg border border-white/20 bg-[#2A3439] small-field">
                </div>
                <div id="8_3" class="aspect-square rounded-lg border border-white/20 bg-[#2A3439] small-field">
                </div>
                <div id="8_4" class="aspect-square rounded-lg border border-white/20 bg-[#2A3439] small-field">
                </div>
                <div id="8_5" class="aspect-square rounded-lg border border-white/20 bg-[#2A3439] small-field">
                </div>
                <div id="8_6" class="aspect-square rounded-lg border border-white/20 bg-[#2A3439] small-field">
                </div>
                <div id="8_7" class="aspect-square rounded-lg border border-white/20 bg-[#2A3439] small-field">
                </div>
                <div id="8_8" class="aspect-square rounded-lg border border-white/20 bg-[#2A3439] small-field">
                </div>
            </div>

        </div>

        <!-- Legende -->
        <div class="mt-6 grid gap-2 text-xs text-slate-300 md:grid-cols-3">
            <p><span class="inline-block h-3 w-3 align-middle rounded ring-2 ring-sky-400 mr-1"></span>Aktives Großfeld
            </p>
            <p><span
                    class="inline-block h-3 w-3 align-middle rounded bg-white/20 ring-1 ring-white/20 mr-1"></span>Inaktiv/gesperrt
            </p>
            <p><span
                    class="inline-block h-3 w-3 align-middle rounded bg-emerald-500/80 ring-1 ring-emerald-300/60 mr-1"></span>Gewonnenes
                Großfeld</p>
        </div>
    </div>

    <!-- Dialog -->
    <dialog id="rulesDialog"
      class="rounded-2xl bg-slate-900 text-slate-100 p-0 w-[min(92vw,32rem)]
            backdrop:bg-black/50 backdrop:backdrop-blur-sm">
      <div class="p-6 space-y-4">
        <h2 class="text-xl font-semibold">Kurz erklärt</h2>

        <div class="rounded-xl bg-white/5 ring-1 ring-white/10 p-4 max-h-[60vh] overflow-auto">
          <ol class="list-decimal pl-5 space-y-2 text-sm text-slate-300">
            <li>Das Spielfeld besteht aus 9 Großfeldern (3×3). Jedes Großfeld ist ein eigenes Tic-Tac-Toe (3×3).</li>
            <li>Dein Zug in einem Kleinfeld bestimmt, in welches Großfeld der/die Nächste setzen muss (Position 0–8).</li>
            <li>Ist dieses Großfeld bereits voll oder gewonnen, darf frei in einem beliebigen offenen Großfeld gesetzt werden.</li>
            <li>Ein Großfeld gilt als gewonnen, wenn darin eine 3er-Reihe erreicht wurde. Ziel ist 3 gewonnene Großfelder in einer Reihe.</li>
          </ol>
        </div>

        <div class="mt-2 flex justify-end">
          <button
            class="rounded-xl bg-transparent border border-white/25 px-3 py-2 text-sm font-medium hover:bg-white/10 smooth"
            onclick="this.closest('dialog').close()">
            Schließen
          </button>
        </div>
      </div>
    </dialog>



    <!-- Game-Over Modal -->
    <!-- Game Over Modal (Winner + Lobbycode + Spielertabelle) -->
    <!-- Game Over Modal (Winner + Lobbycode + Spielertabelle + Buttons) -->
    <dialog id="gameOverDialog"
      class="w-[min(92vw,36rem)] p-0 rounded-3xl bg-white dark:bg-neutral-900 text-neutral-900 dark:text-neutral-100
            shadow-2xl ring-1 ring-black/5 dark:ring-white/10
            backdrop:bg-black/50 backdrop:backdrop-blur-sm">

      <!-- Header -->
      <div class="flex items-start gap-4 p-6 border-b border-black/5 dark:border-white/10">
        <div class="shrink-0 rounded-2xl bg-emerald-500/10 text-emerald-600 dark:text-emerald-400 p-3">🏁</div>
        <div class="flex-1">
          <h2 class="text-2xl font-bold">Spiel beendet</h2>
          <p class="mt-1 text-sm text-neutral-500 dark:text-neutral-400">Ergebnis & Lobby-Übersicht</p>
        </div>
        <button type="button" data-close
          class="rounded-xl p-2 text-neutral-500 hover:text-neutral-700 dark:hover:text-neutral-200
                hover:bg-neutral-100 dark:hover:bg-neutral-800 transition">✕</button>
      </div>

      <!-- Body -->
      <div class="px-6 pb-6 pt-4 space-y-5">
        <!-- Siegerkarte -->
        <div class="rounded-xl ring-1 ring-black/5 dark:ring-white/10  dark:bg-white/5 p-4">
          <p class="text-sm text-neutral-500 dark:text-neutral-400">Sieger der letzten Runde</p>
          <p id="go_winner" class="mt-1 text-2xl font-bold tracking-tight">—</p>
        </div>

        <!-- Lobby-Block -->
        <section class="rounded-2xl ring-1 ring-black/5 dark:ring-white/10 bg-neutral-50/60 dark:bg-white/5">
          <div class="flex items-center justify-between gap-3 p-4 border-b border-black/5 dark:border-white/10">
            <div class="flex items-center gap-2">
              <div class="shrink-0 rounded-xl bg-indigo-500/10 text-indigo-600 dark:text-indigo-400 p-2">🎮</div>
              <h3 class="text-lg font-semibold">Lobby</h3>
            </div>

            <!-- Lobby-Code -->
            <div class="flex items-center gap-2">
              <span class="text-sm text-neutral-500 dark:text-neutral-400">Code</span>
              <span id="go_lobby_code"
                    class="font-mono text-base tracking-widest px-2.5 py-1 rounded-lg
                          bg-white dark:bg-neutral-800 ring-1 ring-black/5 dark:ring-white/10">----</span>
              <!-- <button type="button" id="go_copy_code_btn"
                      class="rounded-lg px-2.5 py-1 text-sm bg-neutral-200/70 dark:bg-neutral-800
                            hover:bg-neutral-200 dark:hover:bg-neutral-700 transition">
                Kopieren
              </button> -->
            </div>
          </div>

          <!-- Spielerliste als Tabelle -->
          <div class="p-4">
            <div class="overflow-hidden rounded-xl ring-1 ring-black/5 dark:ring-white/10">
              <table class="w-full text-sm">
                <thead class="bg-neutral-100 dark:bg-neutral-800/60">
                  <tr class="text-left">
                    <th class="px-3 py-2 w-12">#</th>
                    <th class="px-3 py-2">Spieler</th>
                    <th class="px-3 py-2 w-16">Symbol</th>
                    <th class="px-3 py-2 w-28">Status</th>
                  </tr>
                </thead>
                <tbody id="go_lobby_tbody" class="divide-y divide-black/5 dark:divide-white/10">
                  <!-- JS füllt hier die Zeilen -->
                </tbody>
              </table>
            </div>
            <p id="go_lobby_empty" class="hidden mt-3 text-sm text-neutral-500 dark:text-neutral-400">
              Keine Spieler in der Lobby.
            </p>
          </div>
        </section>

        <!-- Footer-Buttons -->
        <div class="mt-2 flex justify-end gap-2">
          <button id="go_quit_btn" type="button"
            class="px-4 py-2 rounded-lg bg-neutral-700 hover:bg-neutral-600 text-neutral-50 transition">
            Beenden
          </button>
          <button id="go_restart_btn" type="button"
            class="px-4 py-2 rounded-lg bg-emerald-500 hover:bg-emerald-600 text-white font-semibold transition">
            Neustart
          </button>
        </div>
      </div>
    </dialog>


    {% include 'js.html' %}

    <script>
        // eine globale Referenz – nicht mehrfach als "let socket" deklarieren!
        window.socket = null;

        function wsBase() {
            return (location.protocol === "https:" ? "wss://" : "ws://") + location.host;
        }

        document.addEventListener("DOMContentLoaded", () => {
            const roomCode = "{{ room_code }}";                      // aus Django
            const nickname = localStorage.getItem("nickname") || "Spieler";

            // Falls schon was Offenes rumliegt, schließen (nur Vorsicht)
            if (window.socket && window.socket.readyState === WebSocket.OPEN) {
                try { window.socket.close(1000, "reconnect"); } catch (e) { }
            }

            // 1) Verbinden
            const url = `${wsBase()}/ws/game/${encodeURIComponent(roomCode)}/`;
            window.socket = new WebSocket(url);

            // window.socket.addEventListener("open", () => {
            //     console.log("WS open (game page)");
            //     // 2) Im Raum anmelden
            //     // window.socket.send(JSON.stringify({ action: "create_or_join", nickname }));
            //     window.socket.send(JSON.stringify({ action: "get_state" }));
            // });

            window.socket.addEventListener("open", () => {
              const nickname = localStorage.getItem("nickname") || "Spieler";
              // Rejoin: Symbol anhand deines Namens zuweisen
              window.socket.send(JSON.stringify({ action: "create_or_join", nickname }));
              // optional danach: State holen (Board etc.)
              window.socket.send(JSON.stringify({ action: "get_state" }));
            });

            window.socket.addEventListener("message", (e) => {
                const msg = JSON.parse(e.data);
                console.log("WS msg (game page)", msg);

                if (msg.event === "joined") {
                    window.myId = msg.your_id;       // falls dein Server das mitsendet
                    window.mySymbol = msg.your_symbol;  // "X" oder "O"

                    console.log("MSG: (Game PAge)", msg)

                    const mySymbol = document.getElementById("symbol_you");
                    const oponentSymbol = document.getElementById("symbol_oponent");

                    console.log("Your_name: ", msg.players[msg.your_id])
                    const myName = document.getElementById("your_name");
                    const oponent_name = document.getElementById("oponent_name")
                    let your_name = msg.players[msg.your_id]

                    const oppSym  = msg.your_symbol === "X" ? "O" : "X";
                    const oppName = msg.names_by_symbol?.[oppSym] || "";

                    console.log("Opp_Name: ", oppName)


                    myName.innerText = your_name
                    oponent_name.innerText = oppName

                    if(msg.your_symbol == "X"){
                        mySymbol.classList.add('text-red-500')
                        mySymbol.innerText = msg.your_symbol

                       
                        oponentSymbol.classList.add('text-green-500')
                        oponentSymbol.innerText = "O"

                    }else{

                        mySymbol.classList.add('text-green-500')
                        mySymbol.innerText = msg.your_symbol
                        // Text im Status anpassen

                        oponentSymbol.classList.add('text-red-500')
                        oponentSymbol.innerText = "X"

                    }

                    const allSmalls = document.querySelectorAll(".small-field");

                    // über alle iterieren
                    allSmalls.forEach(el => {
                      el.classList.add("cursor-pointer", "hover:bg-[#37444A]");  // z. B. Mauszeiger aktivieren
                      // el.classList.remove("hover:bg-[#37444A]"); // Hover-Effekt entfernen
                    });


                    //NEU !!!!!!!__------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
                    if (msg.names_by_symbol) {
                        applyNamesBySymbol(msg.names_by_symbol);
                      }
                    }

                    // player_list: Namen & Zuordnung aktualisieren, sobald beide drin sind
                    if (msg.event === "player_list") {
                      if (msg.names_by_symbol) {
                        applyNamesBySymbol(msg.names_by_symbol);
                      } else {
                        // Fallback: selbst aus players[] & symbols{} ableiten
                        const byId = {};
                        (msg.players || []).forEach(p => byId[p.id] = p.name);
                        const names = {};
                        for (const [id, sym] of Object.entries(msg.symbols || {})) {
                          if (sym === "X" || sym === "O") names[sym] = byId[id] || "";
                        }
                        applyNamesBySymbol(names);
                      }



                }

                if (msg.event === "move") {
                    window.currentPlayer = msg.currentPlayer; // "X" oder "O"
                    const allSmalls = document.querySelectorAll(".small-field");

                    console.log("CurrentPlayer", window.currentPlayer)
                    console.log("mySymbol", window.mySymbol)
                    

                    // if (window.currentPlayer && window.mySymbol && window.currentPlayer !== window.mySymbol) {
                    //     console.log("Nicht dein Zug.");
                    //     return;
                    // }

                  

                   // 1) überall Hover weg
                  // const allSmalls = document.querySelectorAll(".small-field");
                  allSmalls.forEach(el => el.classList.remove("cursor-pointer", "hover:bg-[#37444A]"));

                  // 2) Ziel-Großfeld & Status ermitteln
                  const targetBig = Number(msg.small);

                  // a) Ist Ziel per Server entschieden?
                  const decidedByServer = Array.isArray(msg.finished_fields) && msg.finished_fields.some(
                    f => Number(f.big) === targetBig && (f.winner === "X" || f.winner === "O" || f.winner === "D")
                  );

                  // b) Lokal voll?
                  const locallyFull = [...Array(9).keys()].every(i => {
                    const el = document.getElementById(`${targetBig}_${i}`);
                    return el && el.innerText.trim() !== "";
                  });

                  const isTargetClosed = decidedByServer || locallyFull;

                  // 3) Menge aller *geschlossenen* Großfelder bilden (gewonnen/Draw oder voll)
                  const closedBigs = new Set();
                  // aus Serverdaten
                  if (Array.isArray(msg.finished_fields)) {
                    msg.finished_fields.forEach(f => {
                      if (f && f.big != null && (f.winner === "X" || f.winner === "O" || f.winner === "D")) {
                        closedBigs.add(Number(f.big));
                      }
                    });
                  }
                  // lokal volle Großfelder ergänzen
                  for (let b = 0; b < 9; b++) {
                    const full = [...Array(9).keys()].every(i => {
                      const el = document.getElementById(`${b}_${i}`);
                      return el && el.innerText.trim() !== "";
                    });
                    if (full) closedBigs.add(b);
                  }

                  // 4) Hover setzen
                  if (isTargetClosed) {
                    // freie Wahl: nur leere Zellen in *offenen* Großfeldern
                    allSmalls.forEach(el => {
                      const [bStr] = el.id.split("_");
                      const b = Number(bStr);
                      const empty = el.innerText.trim() === "";
                      if (empty && !closedBigs.has(b)) {
                        el.classList.add("hover:bg-[#37444A]", "cursor-pointer");
                      }
                    });
                  } else {
                    // nur Ziel-Großfeld: leere Zellen aktivieren
                    for (let i = 0; i < 9; i++) {
                      const el = document.getElementById(`${targetBig}_${i}`);
                      if (el && el.innerText.trim() === "") {
                        el.classList.add("hover:bg-[#37444A]", "cursor-pointer");
                      }
                    }
                  }


                    // console.log("Ein zug auf Feld ", msg.big, msg.small);
                    // let id = msg.big + "_" + msg.small
                    

                    let field_to_click_id = "field_" + msg.small;
                    const next_big_field = document.getElementById(field_to_click_id);

                    let clicked_big_field_id = "field_" + msg.big;
                    const clicked_big_field = document.getElementById(clicked_big_field_id);

                    

                    // console.log("ID: ", id)
                    // console.log("MSG ", msg)
                    // console.log("Player ", msg.currentPlayer)

                    console.log("Spieler am zug: ", msg)
                    if(msg.currentPlayer == window.mySymbol){
                        document.getElementById("status").innerText = "Du bist am zug"
                    }else{
                        document.getElementById("status").innerText = `Der Spieler ${msg.currentPlayer} ist am zug`

                    }

                    const field = document.getElementById(`${msg.big}_${msg.small}`);

                    field.innerText = msg.symbol

                    if (msg.symbol == "X") {
                        field.classList.add(
                            'flex',
                            'items-center',
                            'justify-center',
                            'text-red-500',
                            'text-3xl',
                            'font-bold',
                            'border-2',          // Dicke Border
                            'border-red-500',    // Border-Farbe rot
                            'rounded-lg',        // Abgerundete Ecken
                            'shadow-lg',         // Starker Schatten
                            'shadow-red-500/50', // Rot getönter Glow
                            'transition',        // Sanfte Animation
                            'duration-300',      // Animationsdauer
                            // 'hover:scale-105',   // Leichtes Vergrößern beim Hover
                            'hover:shadow-red-400' // Hellere rote Glow-Farbe beim Hover
                        );
                    } else {
                        field.classList.add(
                            'flex',
                            'items-center',
                            'justify-center',
                            'text-green-500',
                            'text-3xl',
                            'font-bold',
                            'border-2',
                            'border-green-500',
                            'rounded-lg',
                            'shadow-lg',
                            'shadow-green-500/50',
                            'transition',
                            'duration-300',
                            // 'hover:scale-105',
                            'hover:shadow-green-400'
                        );
                    }

                    // clicked_big_field.classList.remove('ring-red-500', 'shadow-lg', 'shadow-red-500/50')
                    clicked_big_field.classList.add('ring-2', 'ring-white', 'shadow-xl')

                    next_big_field.classList.remove('ring-2', 'ring-white', 'shadow-xl');
                    next_big_field.classList.add('ring-2', 'ring-sky-400', 'shadow-lg', 'shadow-sky-400/50');

                    

                    // console.log("Results: " , msg.finished_fields)
                    if (msg.finished_fields){
                      for (let i = 0; i < msg.finished_fields.length; i++) {
                        const field_data = msg.finished_fields[i];
                        const big_field = document.getElementById(`field_${field_data["big"]}`);
                        if (!big_field) continue;

                        if (field_data["winner"] == "X"){
                          big_field.classList.add('ring-4','ring-red-500','shadow-lg','shadow-red-500/50');
                        } else if (field_data["winner"] == "O"){
                          big_field.classList.add('ring-4','ring-green-500','shadow-lg','shadow-green-500/50');
                        } else {
                          big_field.classList.add('ring-4','ring-gray-500','shadow-lg','shadow-gray-500/50');
                        }
                      }
                    }
                    
                }

                if (msg.event === "game_over") {
                  // Sieger-Text
                  const winnerText = msg.winner === "D" ? "Unentschieden" : `Spieler ${msg.winner} gewinnt!`;
                  document.getElementById("status").innerText = winnerText;

                  // Lobby-Code aus Django übernehmen (Großbuchstaben)
                  const lobbyCode = ("{{ room_code }}").toString().toUpperCase();

                  // Namen aus deiner UI nehmen (oben links/rechts)
                  const youName = (document.getElementById("your_name")?.textContent || "Du").trim();
                  const oppName = (document.getElementById("oponent_name")?.textContent || "Gegner").trim();

                  const yourSym = (window.mySymbol || "").toUpperCase();
                  const oppSym  = yourSym === "X" ? "O" : "X";

                  // Nur EINMAL über unsere Helper öffnen & befüllen
                  openGameOverModal({
                    winner: winnerText,
                    lobbyCode,
                    players: [
                      { id: 'you', name: youName || 'Du',   symbol: yourSym || '-',},
                      { id: 'opp', name: oppName || '—',    symbol: oppSym  || '-',}
                    ]
                  });
                }

                if (msg.event === "reset") {
                  // Kleine Felder leeren & Klassen zurück auf Standard
                  document.querySelectorAll(".small-field").forEach(cell => {
                    cell.innerText = "";
                    cell.className = "aspect-square rounded-lg border border-white/20 bg-[#2A3439] small-field";
                  });

                  // Großfelder zurück auf Standard
                  for (let b = 0; b < 9; b++) {
                    const big = document.getElementById(`field_${b}`);
                    if (big) {
                      big.className = "grid grid-cols-3 gap-1 aspect-square rounded-2xl p-1 bg-gradient-to-br from-[#1C2529] to-[#11171A] ring-2 ring-white shadow-xl";
                    }
                  }

                  // Status/Turn zurücksetzen
                  window.currentPlayer = msg.currentPlayer || "X";
                  document.getElementById("status").innerText = "Spiel neugestartet. Spieler X beginnt.";

                  // Hover-Logik initial (freie Wahl)
                  document.querySelectorAll(".small-field").forEach(el => {
                    if (el.innerText.trim() === "") {
                      el.classList.add("hover:bg-[#37444A]", "cursor-pointer");
                    }
                  });

                  // Modal schließen, falls offen
                  const dlg = document.getElementById("gameOverDialog");
                  if (dlg && typeof dlg.close === "function") dlg.close();
                }

                if (msg.event === "state") {
                  console.log("State: ", msg)
                  // wenn du schon applyNamesBySymbol hast:
                  if (msg.names_by_symbol) {
                    applyNamesBySymbol(msg.names_by_symbol);
                  }
                  // optional: Symbol des eigenen Sockets vormerken
                  if (msg.your_symbol) {
                    window.mySymbol = msg.your_symbol;
                  }
                }

                  
                

                if (msg.event === "error") {
                    alert(msg.message || "Fehler");
                }
            });

            window.socket.addEventListener("close", () => console.log("WS closed (game page)"));
            window.socket.addEventListener("error", (e) => console.error("WS error", e));

            // Buttons
            document.getElementById("go_quit_btn").addEventListener("click", () => {
              // Beenden: zurück zur Übersicht o.ä.
              window.location.href = "/"; // passe an deine Route an
            });

            document.getElementById("go_restart_btn").addEventListener("click", () => {
              if (window.socket && window.socket.readyState === WebSocket.OPEN) {
                window.socket.send(JSON.stringify({ action: "reset" }));
              }
            });

            document.getElementById("resetBtn").addEventListener("click", () => {
              if (window.socket && window.socket.readyState === WebSocket.OPEN) {
                window.socket.send(JSON.stringify({ action: "reset" }));
              }
            });

            // 3) Klicks an die WS schicken – Event Delegation ist robust
            const board = document.getElementById("board");
            board.addEventListener("click", (ev) => {
                const cell = ev.target.closest("#board > div > div"); // deine kleinen Zellen
                if (!cell) return;

                // Indizes aus Position ableiten (oder setz dir data-Attribute im HTML)
                const allCells = [...document.querySelectorAll("#board > div > div")];
                const index = allCells.indexOf(cell);
                if (index < 0) return;

                const big = Math.floor(index / 9);
                const small = index % 9;

                if (!window.socket || window.socket.readyState !== WebSocket.OPEN) {
                    console.warn("WS nicht offen – move nicht gesendet");
                    return;
                }

                console.log(big, small)
                window.socket.send(JSON.stringify({
                    action: "game_move",
                    big,
                    small
                }));
            });
        });
        
    </script>

    <script>
      function applyNamesBySymbol(names) {
        // Für spätere Snapshots merken (z.B. wenn player_list kein Symbol mitliefert)
        window.namesBySymbol = { ...(window.namesBySymbol || {}), ...(names || {}) };
      }


            // Modal öffnen & befüllen
      function openGameOverModal({ winner, lobbyCode, players }) {
        document.getElementById('go_winner').textContent = winner ?? '—';
        updateLobbyCode(lobbyCode);
        renderLobbyTable(players ?? []);

        const dlg = document.getElementById('gameOverDialog');
        if (!dlg.open) dlg.showModal();
        // softer Fade/Scale beim Öffnen
        dlg.classList.add('opacity-0', 'scale-95', 'transition', 'duration-200');
        requestAnimationFrame(() => dlg.classList.remove('opacity-0', 'scale-95'));
      }

      // Lobbycode setzen + Kopieren-Button funktioniert
      function updateLobbyCode(code) {
        const el = document.getElementById('go_lobby_code');
        el.textContent = (code ?? '----').toString().toUpperCase();
      }

      // Tabelle initial rendern (Snapshot)
      function renderLobbyTable(players) {
        const tbody = document.getElementById('go_lobby_tbody');
        const empty = document.getElementById('go_lobby_empty');
        tbody.innerHTML = '';

        if (!players || players.length === 0) {
          empty.classList.remove('hidden');
          return;
        }
        empty.classList.add('hidden');

        players.forEach((p, i) => tbody.appendChild(makeRow(p, i)));
      }

      // Row-Badge je Status
      // function setBadge(el, statusRaw) {
      //   const status = (statusRaw ?? 'offline').toLowerCase();
      //   const map = {
      //     bereit:   'bg-emerald-500/15 text-emerald-600 dark:text-emerald-400',
      //     online:   'bg-blue-500/15 text-blue-600 dark:text-blue-400',
      //     offline:  'bg-neutral-500/15 text-neutral-600 dark:text-neutral-400',
      //     wartet:   'bg-amber-500/15 text-amber-600 dark:text-amber-400',
      //     verbunden:'bg-indigo-500/15 text-indigo-600 dark:text-indigo-400'
      //   };
      //   el.className = `px-2 py-0.5 rounded-lg text-xs font-medium ${map[status] ?? map.offline}`;
      //   el.textContent = statusRaw ?? 'offline';
      // }

      // Tabellenzeile erstellen
      function makeRow(p, index) {
        const tr = document.createElement('tr');
        tr.dataset.key = (p?.id ?? p?.name ?? '').toString();

        const tdIdx = document.createElement('td');
        tdIdx.className = 'px-3 py-2 text-neutral-500 dark:text-neutral-400';
        tdIdx.textContent = String(index + 1);

        const tdName = document.createElement('td');
        tdName.className = 'px-3 py-2 font-medium';
        tdName.textContent = p?.name ?? 'Unbekannt';

        const tdSym = document.createElement('td');
        tdSym.className = 'px-3 py-2';
        tdSym.textContent = p?.symbol ?? '-';

        // const tdStat = document.createElement('td');
        // tdStat.className = 'px-3 py-2';
        // const badge = document.createElement('span');
        // setBadge(badge, p?.status);
        // tdStat.appendChild(badge);

        // tr.append(tdIdx, tdName, tdSym, tdStat);
        tr.append(tdIdx, tdName, tdSym);
        return tr;
      }

      /* ======== UX: Kopieren, Schließen, Backdrop ======== */

      // Code kopieren
      document.addEventListener('click', async (e) => {
        const btn = e.target.closest('#go_copy_code_btn');
        if (!btn) return;
        const txt = document.getElementById('go_lobby_code')?.textContent?.trim();
        if (!txt) return;
        try {
          await navigator.clipboard.writeText(txt);
          btn.textContent = 'Kopiert!';
          setTimeout(() => (btn.textContent = 'Kopieren'), 1200);
        } catch {}
      });

      // Schließen per [data-close]
      document.addEventListener('click', (e) => {
        const btn = e.target.closest('[data-close]');
        if (!btn) return;
        const dlg = btn.closest('dialog');
        if (dlg?.open) dlg.close('close');
      });

      // Backdrop-Klick (für <dialog>)
      document.getElementById('gameOverDialog')?.addEventListener('click', (e) => {
        const dlg = e.currentTarget;
        const rect = dlg.getBoundingClientRect();
        const outside = e.clientX < rect.left || e.clientX > rect.right || e.clientY < rect.top || e.clientY > rect.bottom;
        if (outside) dlg.close('backdrop');
      });

      /* ======== OPTIONAL: Live-Update später möglich ========
        Wenn du später WebSocket-Events hast, kannst du einfach:
        - updateLobbyCode(newCode)
        - renderLobbyTable(newPlayers)  // kompletter Snapshot
        oder eine diffende Variante nachrüsten.
      ======================================================== */
    </script>

</body>

</html>
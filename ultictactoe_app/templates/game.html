<!DOCTYPE html>
<html lang="de">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Ultimate Tic-Tac-Toe – Tailwind</title>
    <!-- Tailwind via CDN für Demo. In Produktion gern lokal einbinden. -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Sanfte Übergänge für Statusänderungen */
        .smooth {
            transition: all 180ms ease-in-out;
        }
    </style>
</head>

<body class="min-h-screen bg-[#12181B] text-slate-100 antialiased">
    <div class="mx-auto max-w-3xl px-4 py-8">
        <header class="mb-6 flex items-center justify-between">
            <h1 class="text-2xl md:text-3xl font-semibold tracking-tight">Ultimate Tic-Tac-Toe</h1>
            <h1>Lobby Code: {{ room_code }}</h1>
            <div class="flex gap-2">
                <button id="resetBtn"
                    class="rounded-xl bg-transparent border border-white/25 px-3 py-2 text-sm font-medium hover:bg-white/10 active:bg-white/15 smooth"
                    type="button">
                    Neu starten
                </button>
                <button id="helpBtn"
                    class="rounded-xl bg-transparent border border-white/25 px-3 py-2 text-sm font-medium hover:bg-white/10 active:bg-white/15 smooth"
                    type="button" onclick="document.getElementById('rulesDialog').showModal()">
                    Regeln
                </button>
            </div>
        </header>

        <!-- Statusleiste -->
        <div id="status" class="mb-5 rounded-xl bg-white/5 ring-1 ring-white/10 p-3 text-sm">
            Spieler <span class="font-semibold" id="playerSpan">X</span> ist dran.
        </div>

        <!-- Spielfeld: 3x3 Großfelder, jedes enthält ein 3x3 Kleinraster -->
        <!-- Spielfeld: 3x3 Großfelder, jedes enthält ein 3x3 Kleinraster -->
        <div id="board"
            class="mx-auto aspect-square w-full max-w-2xl grid grid-cols-3 gap-3 p-3 rounded-2xl bg-[#0F1518]/40 ring-1 ring-white/10 shadow-2xl backdrop-blur-sm">

            <!-- Großfeld 0 -->
            <div id="field_0"
                class="grid grid-cols-3 gap-1 aspect-square rounded-2xl p-1 bg-gradient-to-br from-[#1C2529] to-[#11171A] ring-2 ring-white shadow-xl">
                <div id="0_0" class="aspect-square rounded-lg border border-white/20 bg-[#2A3439] hover:bg-[#37444A]">
                </div>
                <div id="0_1" class="aspect-square rounded-lg border border-white/20 bg-[#2A3439] hover:bg-[#37444A]">
                </div>
                <div id="0_2" class="aspect-square rounded-lg border border-white/20 bg-[#2A3439] hover:bg-[#37444A]">
                </div>
                <div id="0_3" class="aspect-square rounded-lg border border-white/20 bg-[#2A3439] hover:bg-[#37444A]">
                </div>
                <div id="0_4" class="aspect-square rounded-lg border border-white/20 bg-[#2A3439] hover:bg-[#37444A]">
                </div>
                <div id="0_5" class="aspect-square rounded-lg border border-white/20 bg-[#2A3439] hover:bg-[#37444A]">
                </div>
                <div id="0_6" class="aspect-square rounded-lg border border-white/20 bg-[#2A3439] hover:bg-[#37444A]">
                </div>
                <div id="0_7" class="aspect-square rounded-lg border border-white/20 bg-[#2A3439] hover:bg-[#37444A]">
                </div>
                <div id="0_8" class="aspect-square rounded-lg border border-white/20 bg-[#2A3439] hover:bg-[#37444A]">
                </div>
            </div>

            <!-- Großfeld 1 -->
            <div id="field_1"
                class="grid grid-cols-3 gap-1 aspect-square rounded-2xl p-1 bg-gradient-to-br from-[#1C2529] to-[#11171A] ring-2 ring-white shadow-xl">
                <div id="1_0" class="aspect-square rounded-lg border border-white/20 bg-[#2A3439] hover:bg-[#37444A]">
                </div>
                <div id="1_1" class="aspect-square rounded-lg border border-white/20 bg-[#2A3439] hover:bg-[#37444A]">
                </div>
                <div id="1_2" class="aspect-square rounded-lg border border-white/20 bg-[#2A3439] hover:bg-[#37444A]">
                </div>
                <div id="1_3" class="aspect-square rounded-lg border border-white/20 bg-[#2A3439] hover:bg-[#37444A]">
                </div>
                <div id="1_4" class="aspect-square rounded-lg border border-white/20 bg-[#2A3439] hover:bg-[#37444A]">
                </div>
                <div id="1_5" class="aspect-square rounded-lg border border-white/20 bg-[#2A3439] hover:bg-[#37444A]">
                </div>
                <div id="1_6" class="aspect-square rounded-lg border border-white/20 bg-[#2A3439] hover:bg-[#37444A]">
                </div>
                <div id="1_7" class="aspect-square rounded-lg border border-white/20 bg-[#2A3439] hover:bg-[#37444A]">
                </div>
                <div id="1_8" class="aspect-square rounded-lg border border-white/20 bg-[#2A3439] hover:bg-[#37444A]">
                </div>
            </div>

            <!-- Großfeld 2 -->
            <div id="field_2"
                class="grid grid-cols-3 gap-1 aspect-square rounded-2xl p-1 bg-gradient-to-br from-[#1C2529] to-[#11171A] ring-2 ring-white shadow-xl">
                <div id="2_0" class="aspect-square rounded-lg border border-white/20 bg-[#2A3439] hover:bg-[#37444A]">
                </div>
                <div id="2_1" class="aspect-square rounded-lg border border-white/20 bg-[#2A3439] hover:bg-[#37444A]">
                </div>
                <div id="2_2" class="aspect-square rounded-lg border border-white/20 bg-[#2A3439] hover:bg-[#37444A]">
                </div>
                <div id="2_3" class="aspect-square rounded-lg border border-white/20 bg-[#2A3439] hover:bg-[#37444A]">
                </div>
                <div id="2_4" class="aspect-square rounded-lg border border-white/20 bg-[#2A3439] hover:bg-[#37444A]">
                </div>
                <div id="2_5" class="aspect-square rounded-lg border border-white/20 bg-[#2A3439] hover:bg-[#37444A]">
                </div>
                <div id="2_6" class="aspect-square rounded-lg border border-white/20 bg-[#2A3439] hover:bg-[#37444A]">
                </div>
                <div id="2_7" class="aspect-square rounded-lg border border-white/20 bg-[#2A3439] hover:bg-[#37444A]">
                </div>
                <div id="2_8" class="aspect-square rounded-lg border border-white/20 bg-[#2A3439] hover:bg-[#37444A]">
                </div>
            </div>

            <!-- Großfeld 3 -->
            <div id="field_3"
                class="grid grid-cols-3 gap-1 aspect-square rounded-2xl p-1 bg-gradient-to-br from-[#1C2529] to-[#11171A] ring-2 ring-white shadow-xl">
                <div id="3_0" class="aspect-square rounded-lg border border-white/20 bg-[#2A3439] hover:bg-[#37444A]">
                </div>
                <div id="3_1" class="aspect-square rounded-lg border border-white/20 bg-[#2A3439] hover:bg-[#37444A]">
                </div>
                <div id="3_2" class="aspect-square rounded-lg border border-white/20 bg-[#2A3439] hover:bg-[#37444A]">
                </div>
                <div id="3_3" class="aspect-square rounded-lg border border-white/20 bg-[#2A3439] hover:bg-[#37444A]">
                </div>
                <div id="3_4" class="aspect-square rounded-lg border border-white/20 bg-[#2A3439] hover:bg-[#37444A]">
                </div>
                <div id="3_5" class="aspect-square rounded-lg border border-white/20 bg-[#2A3439] hover:bg-[#37444A]">
                </div>
                <div id="3_6" class="aspect-square rounded-lg border border-white/20 bg-[#2A3439] hover:bg-[#37444A]">
                </div>
                <div id="3_7" class="aspect-square rounded-lg border border-white/20 bg-[#2A3439] hover:bg-[#37444A]">
                </div>
                <div id="3_8" class="aspect-square rounded-lg border border-white/20 bg-[#2A3439] hover:bg-[#37444A]">
                </div>
            </div>

            <!-- Großfeld 4 -->
            <div id="field_4"
                class="grid grid-cols-3 gap-1 aspect-square rounded-2xl p-1 bg-gradient-to-br from-[#1C2529] to-[#11171A] ring-2 ring-white shadow-xl">
                <div id="4_0" class="aspect-square rounded-lg border border-white/20 bg-[#2A3439] hover:bg-[#37444A]">
                </div>
                <div id="4_1" class="aspect-square rounded-lg border border-white/20 bg-[#2A3439] hover:bg-[#37444A]">
                </div>
                <div id="4_2" class="aspect-square rounded-lg border border-white/20 bg-[#2A3439] hover:bg-[#37444A]">
                </div>
                <div id="4_3" class="aspect-square rounded-lg border border-white/20 bg-[#2A3439] hover:bg-[#37444A]">
                </div>
                <div id="4_4" class="aspect-square rounded-lg border border-white/20 bg-[#2A3439] hover:bg-[#37444A]">
                </div>
                <div id="4_5" class="aspect-square rounded-lg border border-white/20 bg-[#2A3439] hover:bg-[#37444A]">
                </div>
                <div id="4_6" class="aspect-square rounded-lg border border-white/20 bg-[#2A3439] hover:bg-[#37444A]">
                </div>
                <div id="4_7" class="aspect-square rounded-lg border border-white/20 bg-[#2A3439] hover:bg-[#37444A]">
                </div>
                <div id="4_8" class="aspect-square rounded-lg border border-white/20 bg-[#2A3439] hover:bg-[#37444A]">
                </div>
            </div>

            <!-- Großfeld 5 -->
            <div id="field_5"
                class="grid grid-cols-3 gap-1 aspect-square rounded-2xl p-1 bg-gradient-to-br from-[#1C2529] to-[#11171A] ring-2 ring-white shadow-xl">
                <div id="5_0" class="aspect-square rounded-lg border border-white/20 bg-[#2A3439] hover:bg-[#37444A]">
                </div>
                <div id="5_1" class="aspect-square rounded-lg border border-white/20 bg-[#2A3439] hover:bg-[#37444A]">
                </div>
                <div id="5_2" class="aspect-square rounded-lg border border-white/20 bg-[#2A3439] hover:bg-[#37444A]">
                </div>
                <div id="5_3" class="aspect-square rounded-lg border border-white/20 bg-[#2A3439] hover:bg-[#37444A]">
                </div>
                <div id="5_4" class="aspect-square rounded-lg border border-white/20 bg-[#2A3439] hover:bg-[#37444A]">
                </div>
                <div id="5_5" class="aspect-square rounded-lg border border-white/20 bg-[#2A3439] hover:bg-[#37444A]">
                </div>
                <div id="5_6" class="aspect-square rounded-lg border border-white/20 bg-[#2A3439] hover:bg-[#37444A]">
                </div>
                <div id="5_7" class="aspect-square rounded-lg border border-white/20 bg-[#2A3439] hover:bg-[#37444A]">
                </div>
                <div id="5_8" class="aspect-square rounded-lg border border-white/20 bg-[#2A3439] hover:bg-[#37444A]">
                </div>
            </div>

            <!-- Großfeld 6 -->
            <div id="field_6"
                class="grid grid-cols-3 gap-1 aspect-square rounded-2xl p-1 bg-gradient-to-br from-[#1C2529] to-[#11171A] ring-2 ring-white shadow-xl">
                <div id="6_0" class="aspect-square rounded-lg border border-white/20 bg-[#2A3439] hover:bg-[#37444A]">
                </div>
                <div id="6_1" class="aspect-square rounded-lg border border-white/20 bg-[#2A3439] hover:bg-[#37444A]">
                </div>
                <div id="6_2" class="aspect-square rounded-lg border border-white/20 bg-[#2A3439] hover:bg-[#37444A]">
                </div>
                <div id="6_3" class="aspect-square rounded-lg border border-white/20 bg-[#2A3439] hover:bg-[#37444A]">
                </div>
                <div id="6_4" class="aspect-square rounded-lg border border-white/20 bg-[#2A3439] hover:bg-[#37444A]">
                </div>
                <div id="6_5" class="aspect-square rounded-lg border border-white/20 bg-[#2A3439] hover:bg-[#37444A]">
                </div>
                <div id="6_6" class="aspect-square rounded-lg border border-white/20 bg-[#2A3439] hover:bg-[#37444A]">
                </div>
                <div id="6_7" class="aspect-square rounded-lg border border-white/20 bg-[#2A3439] hover:bg-[#37444A]">
                </div>
                <div id="6_8" class="aspect-square rounded-lg border border-white/20 bg-[#2A3439] hover:bg-[#37444A]">
                </div>
            </div>

            <!-- Großfeld 7 -->
            <div id="field_7"
                class="grid grid-cols-3 gap-1 aspect-square rounded-2xl p-1 bg-gradient-to-br from-[#1C2529] to-[#11171A] ring-2 ring-white shadow-xl">
                <div id="7_0" class="aspect-square rounded-lg border border-white/20 bg-[#2A3439] hover:bg-[#37444A]">
                </div>
                <div id="7_1" class="aspect-square rounded-lg border border-white/20 bg-[#2A3439] hover:bg-[#37444A]">
                </div>
                <div id="7_2" class="aspect-square rounded-lg border border-white/20 bg-[#2A3439] hover:bg-[#37444A]">
                </div>
                <div id="7_3" class="aspect-square rounded-lg border border-white/20 bg-[#2A3439] hover:bg-[#37444A]">
                </div>
                <div id="7_4" class="aspect-square rounded-lg border border-white/20 bg-[#2A3439] hover:bg-[#37444A]">
                </div>
                <div id="7_5" class="aspect-square rounded-lg border border-white/20 bg-[#2A3439] hover:bg-[#37444A]">
                </div>
                <div id="7_6" class="aspect-square rounded-lg border border-white/20 bg-[#2A3439] hover:bg-[#37444A]">
                </div>
                <div id="7_7" class="aspect-square rounded-lg border border-white/20 bg-[#2A3439] hover:bg-[#37444A]">
                </div>
                <div id="7_8" class="aspect-square rounded-lg border border-white/20 bg-[#2A3439] hover:bg-[#37444A]">
                </div>
            </div>

            <!-- Großfeld 8 -->
            <div id="field_8"
                class="grid grid-cols-3 gap-1 aspect-square rounded-2xl p-1 bg-gradient-to-br from-[#1C2529] to-[#11171A] ring-2 ring-white shadow-xl">
                <div id="8_0" class="aspect-square rounded-lg border border-white/20 bg-[#2A3439] hover:bg-[#37444A]">
                </div>
                <div id="8_1" class="aspect-square rounded-lg border border-white/20 bg-[#2A3439] hover:bg-[#37444A]">
                </div>
                <div id="8_2" class="aspect-square rounded-lg border border-white/20 bg-[#2A3439] hover:bg-[#37444A]">
                </div>
                <div id="8_3" class="aspect-square rounded-lg border border-white/20 bg-[#2A3439] hover:bg-[#37444A]">
                </div>
                <div id="8_4" class="aspect-square rounded-lg border border-white/20 bg-[#2A3439] hover:bg-[#37444A]">
                </div>
                <div id="8_5" class="aspect-square rounded-lg border border-white/20 bg-[#2A3439] hover:bg-[#37444A]">
                </div>
                <div id="8_6" class="aspect-square rounded-lg border border-white/20 bg-[#2A3439] hover:bg-[#37444A]">
                </div>
                <div id="8_7" class="aspect-square rounded-lg border border-white/20 bg-[#2A3439] hover:bg-[#37444A]">
                </div>
                <div id="8_8" class="aspect-square rounded-lg border border-white/20 bg-[#2A3439] hover:bg-[#37444A]">
                </div>
            </div>

        </div>

        <!-- Legende -->
        <div class="mt-6 grid gap-2 text-xs text-slate-300 md:grid-cols-3">
            <p><span class="inline-block h-3 w-3 align-middle rounded ring-2 ring-sky-400 mr-1"></span>Aktives Großfeld
            </p>
            <p><span
                    class="inline-block h-3 w-3 align-middle rounded bg-white/20 ring-1 ring-white/20 mr-1"></span>Inaktiv/gesperrt
            </p>
            <p><span
                    class="inline-block h-3 w-3 align-middle rounded bg-emerald-500/80 ring-1 ring-emerald-300/60 mr-1"></span>Gewonnenes
                Großfeld</p>
        </div>
    </div>

    <!-- Dialog -->
    <dialog id="rulesDialog" class="rounded-2xl bg-slate-900 text-slate-100 p-0 w-[min(92vw,48rem)]">
        <div class="p-5">
            <h2 class="text-lg font-semibold">Kurz erklärt</h2>
            <ol class="mt-3 list-decimal pl-5 space-y-2 text-sm text-slate-300">
                <li>Das Spielfeld besteht aus 9 Großfeldern (3×3). Jedes Großfeld ist ein eigenes Tic-Tac-Toe (3×3).
                </li>
                <li>Dein Zug in einem Kleinfeld bestimmt, in welches Großfeld der/die Nächste setzen muss (Position
                    0–8).</li>
                <li>Ist dieses Großfeld bereits voll oder gewonnen, darf frei in einem beliebigen offenen Großfeld
                    gesetzt werden.</li>
                <li>Ein Großfeld gilt als gewonnen, wenn darin eine 3er-Reihe erreicht wurde. Ziel ist 3 gewonnene
                    Großfelder in einer Reihe.</li>
            </ol>
            <div class="mt-4 flex justify-end gap-2">
                <button
                    class="rounded-xl bg-transparent border border-white/25 px-3 py-2 text-sm font-medium hover:bg-white/10 smooth"
                    onclick="this.closest('dialog').close()">Schließen</button>
            </div>
        </div>
    </dialog>

    {% include 'js.html' %}

    <script>
        // eine globale Referenz – nicht mehrfach als "let socket" deklarieren!
        window.socket = null;

        function wsBase() {
            return (location.protocol === "https:" ? "wss://" : "ws://") + location.host;
        }

        document.addEventListener("DOMContentLoaded", () => {
            const roomCode = "{{ room_code }}";                      // aus Django
            const nickname = localStorage.getItem("nickname") || "Spieler";

            // Falls schon was Offenes rumliegt, schließen (nur Vorsicht)
            if (window.socket && window.socket.readyState === WebSocket.OPEN) {
                try { window.socket.close(1000, "reconnect"); } catch (e) { }
            }

            // 1) Verbinden
            const url = `${wsBase()}/ws/game/${encodeURIComponent(roomCode)}/`;
            window.socket = new WebSocket(url);

            window.socket.addEventListener("open", () => {
                console.log("WS open (game page)");
                // 2) Im Raum anmelden
                window.socket.send(JSON.stringify({ action: "create_or_join", nickname }));
            });

            window.socket.addEventListener("message", (e) => {
                const msg = JSON.parse(e.data);
                console.log("WS msg (game page)", msg);

                if (msg.event === "joined") {
                    window.myId = msg.your_id;       // falls dein Server das mitsendet
                }

                if (msg.event === "move") {
                    console.log("Ein zug auf Feld ", msg.big, msg.small);
                    let id = msg.big + "_" + msg.small

                    let field_to_click_id = "field_" + msg.small;
                    const next_big_field = document.getElementById(field_to_click_id);

                    let clicked_big_field_id = "field_" + msg.big;
                    const clicked_big_field = document.getElementById(clicked_big_field_id);

                    console.log("ID: ", id)
                    console.log("MSG ", msg)
                    console.log("Player ", msg.currentPlayer)

                    document.getElementById("playerSpan").innerText = msg.currentPlayer

                    const field = document.getElementById(id);

                    // let field_symbol = "X"

                    // if (msg.currentPlayer == "X") {
                    //     field_symbol = "O"
                    // } else {
                    //     field_symbol = "X";
                    // }

                    field.innerText = msg.symbol

                    if (msg.symbol == "X") {
                        field.classList.add(
                            'flex',
                            'items-center',
                            'justify-center',
                            'text-red-500',
                            'text-3xl',
                            'font-bold',
                            'border-2',          // Dicke Border
                            'border-red-500',    // Border-Farbe rot
                            'rounded-lg',        // Abgerundete Ecken
                            'shadow-lg',         // Starker Schatten
                            'shadow-red-500/50', // Rot getönter Glow
                            'transition',        // Sanfte Animation
                            'duration-300',      // Animationsdauer
                            'hover:scale-105',   // Leichtes Vergrößern beim Hover
                            'hover:shadow-red-400' // Hellere rote Glow-Farbe beim Hover
                        );
                    } else {
                        field.classList.add(
                            'flex',
                            'items-center',
                            'justify-center',
                            'text-green-500',
                            'text-3xl',
                            'font-bold',
                            'border-2',
                            'border-green-500',
                            'rounded-lg',
                            'shadow-lg',
                            'shadow-green-500/50',
                            'transition',
                            'duration-300',
                            'hover:scale-105',
                            'hover:shadow-green-400'
                        );
                    }

                    clicked_big_field.classList.remove('ring-red-500', 'shadow-lg', 'shadow-red-500/50')
                    next_big_field.classList.add('ring-red-500', 'shadow-lg', 'shadow-red-500/50');


                    console.log(msg.bigResults)
                    if (msg.bigResults) {
                    // Gewonnene Großfelder ring/Glow markieren (nur Utilities, kein eigenes CSS)
                        Object.entries(msg.bigResults || {}).forEach(([bigIndex, result]) => {
                        const fieldBig = document.getElementById(`field_${bigIndex}`);
                        if (!fieldBig) return;

                        // Alte Ringe/Umrandungen/Glows entfernen (aber NICHT das Grid/Rounded/etc.)
                        fieldBig.classList.remove(
                            'ring-2','ring-4','ring-white','ring-red-500','ring-green-500','ring-slate-500',
                            'border-4','border-red-500','border-green-500','border-slate-500',
                            'shadow-lg','shadow-red-500/50','shadow-green-500/50','shadow-slate-500/50'
                        );

                        if (result === 'X') {
                            // Roter Gewinner-Ring + roter Glow
                            fieldBig.classList.add('ring-4','ring-red-500','shadow-lg','shadow-red-500/50');
                        } else if (result === 'O') {
                            // Grüner Gewinner-Ring + grüner Glow
                            fieldBig.classList.add('ring-4','ring-green-500','shadow-lg','shadow-green-500/50');
                        } else if (result === 'T') {
                            // Unentschieden neutral (kein Tailwind-dashed-Ring ohne Custom-CSS)
                            fieldBig.classList.add('border-4','border-slate-500');
                        } else {
                            // Nicht entschieden -> Standardzustand
                            fieldBig.classList.add('ring-2','ring-white');
                        }
                        });
                    }

                    // next_big_field.classList.add(
                       

                    // )

                    // field.innerText = field_symbol

                    // TODO: UI aktualisieren (Zug zeichnen etc.)
                }

                if (msg.event === "board_update") {
                    // TODO: UI aktualisieren (Zug zeichnen etc.)
                }

                if (msg.event === "error") {
                    alert(msg.message || "Fehler");
                }
            });

            window.socket.addEventListener("close", () => console.log("WS closed (game page)"));
            window.socket.addEventListener("error", (e) => console.error("WS error", e));

            // 3) Klicks an die WS schicken – Event Delegation ist robust
            const board = document.getElementById("board");
            board.addEventListener("click", (ev) => {
                const cell = ev.target.closest("#board > div > div"); // deine kleinen Zellen
                if (!cell) return;

                // Indizes aus Position ableiten (oder setz dir data-Attribute im HTML)
                const allCells = [...document.querySelectorAll("#board > div > div")];
                const index = allCells.indexOf(cell);
                if (index < 0) return;

                const big = Math.floor(index / 9);
                const small = index % 9;

                if (!window.socket || window.socket.readyState !== WebSocket.OPEN) {
                    console.warn("WS nicht offen – move nicht gesendet");
                    return;
                }

                console.log(big, small)
                window.socket.send(JSON.stringify({
                    action: "game_move",
                    big,
                    small
                }));
            });
        });
    </script>

    <!-- <script>
    /**
     * Struktur:
     * - 9 Subboards (0..8). Jedes Subboard hat 9 Zellen (0..8).
     * - Ein Klick schreibt ein "X" oder "O" in die Zelle, wenn erlaubt.
     * - Der nächste aktive Subboard-Index = geklickte Kleinzellen-Position.
     * - Wenn dieses Ziel-Subboard gewonnen/voll ist, sind alle offenen Subboards aktiv.
     */

    const boardEl = document.getElementById('board');
    const statusEl = document.getElementById('status');
    const playerSpan = document.getElementById('playerSpan');
    const resetBtn = document.getElementById('resetBtn');
    const helpBtn = document.getElementById('helpBtn');
    const rulesDialog = document.getElementById('rulesDialog');

    const PLAYERS = ['X', 'O'];

    // State
    let state;

    function initialState() {
      return {
        current: 0,              // 0 = X, 1 = O
        subboards: Array.from({ length: 9 }, () => Array(9).fill(null)), // 9x9
        subWinners: Array(9).fill(null),   // Gewinner je Subboard: 'X' | 'O' | 'T' (Tie) | null
        nextActive: null,        // null = frei wählbar, sonst 0..8
        gameWinner: null,        // 'X' | 'O' | 'T' | null
        lastMove: null           // {sb, cell}
      };
    }

    // Gewinnmuster (Index in 3x3-Raster)
    const wins = [
      [0,1,2],[3,4,5],[6,7,8], // Reihen
      [0,3,6],[1,4,7],[2,5,8], // Spalten
      [0,4,8],[2,4,6]          // Diagonalen
    ];

    function buildBoard() {
      boardEl.innerHTML = '';
      for (let sb = 0; sb < 9; sb++) {
        const sub = document.createElement('div');
        sub.className = [
          'relative grid grid-cols-3 gap-1 aspect-square rounded-2xl p-1',
          'bg-slate-900 border-2 border-slate-700'
        ].join(' ');
        sub.dataset.sb = sb;

        // Overlay für Gewinner-Kennzeichnung
        const overlay = document.createElement('div');
        overlay.className = 'pointer-events-none absolute inset-0 hidden items-center justify-center rounded-2xl bg-emerald-600/20';
        overlay.innerHTML = '<span class="text-4xl md:text-5xl font-bold">✓</span>';
        overlay.dataset.overlay = '1';
        sub.appendChild(overlay);

        for (let cell = 0; cell < 9; cell++) {
          const btn = document.createElement('button');
          btn.type = 'button';
          btn.className = [
            'smooth rounded-xl aspect-square flex items-center justify-center',
            'text-xl md:text-3xl font-semibold select-none',
            'bg-slate-800 hover:bg-slate-700 disabled:opacity-60 disabled:cursor-not-allowed'
          ].join(' ');
          btn.dataset.sb = sb;
          btn.dataset.cell = cell;
          btn.addEventListener('click', onCellClick);
          sub.appendChild(btn);
        }

        boardEl.appendChild(sub);
      }
      refreshUI();
    }

    function onCellClick(e) {
      const sb = Number(e.currentTarget.dataset.sb);
      const cell = Number(e.currentTarget.dataset.cell);

      if (state.gameWinner) return; // Spiel vorbei

      // Aktivitätsprüfung
      if (state.nextActive !== null && state.nextActive !== sb) return;
      if (state.subWinners[sb]) return; // Subboard bereits entschieden
      if (state.subboards[sb][cell]) return; // Feld belegt

      // Zug eintragen
      const player = PLAYERS[state.current];
      state.subboards[sb][cell] = player;
      state.lastMove = { sb, cell };

      // Subboard auswerten
      const sbWinner = evalWinner(state.subboards[sb]);
      state.subWinners[sb] = sbWinner;

      // Gesamtsieg auswerten (auf Basis der Subboard-Gewinner)
      state.gameWinner = evalWinner(state.subWinners.map(x => x === null ? '' : (x === 'T' ? '' : x)));

      // Nächstes aktives Subboard festlegen
      if (!state.gameWinner) {
        const target = cell; // Nächstes Großfeld = Position der Kleinzelle
        const targetDone = state.subWinners[target] !== null || state.subboards[target].every(Boolean);
        state.nextActive = targetDone ? null : target;

        // Spielerwechsel
        state.current = 1 - state.current;
      }

      refreshUI();
    }

    function evalWinner(cells) {
      // cells: Array(9) mit 'X'/'O'/''/null
      for (const [a,b,c] of wins) {
        const v = cells[a];
        if (v && v === cells[b] && v === cells[c]) return v; // 'X' oder 'O'
      }
      if (cells.every(v => v)) return 'T'; // Unentschieden
      return null; // offen
    }

    function refreshUI() {
      // Buttons/Zeichen rendern
      for (const sub of boardEl.children) {
        if (!sub.dataset) continue;
        const sb = Number(sub.dataset.sb);
        const overlay = sub.querySelector('[data-overlay]');
        const buttons = sub.querySelectorAll('button');

        // Overlay/Win-Status
        if (state.subWinners[sb] && state.subWinners[sb] !== 'T') {
          overlay.classList.remove('hidden');
          overlay.classList.add('flex');
        } else {
          overlay.classList.add('hidden');
          overlay.classList.remove('flex');
        }

        // Aktivität markieren
        const isActive = state.nextActive === null
          ? !state.subWinners[sb] && !state.subboards[sb].every(Boolean)
          : state.nextActive === sb;

        sub.classList.toggle('ring-2', isActive);
        sub.classList.toggle('ring-sky-400', isActive);
        sub.classList.toggle('animate-pulse', isActive);

        // Zellen rendern/aktivieren
        buttons.forEach(btn => {
          const cell = Number(btn.dataset.cell);
          const v = state.subboards[sb][cell];
          btn.textContent = v ? v : '';
          const taken = Boolean(v);
          const locked = !isActive || state.subWinners[sb] !== null || state.gameWinner;
          btn.disabled = taken || locked;
        });
      }

      // Statusleiste
      if (state.gameWinner) {
        if (state.gameWinner === 'T') {
          statusEl.textContent = 'Unentschieden!';
        } else {
          statusEl.innerHTML = `Spielende: <span class="font-semibold">${state.gameWinner}</span> gewinnt!`;
        }
      } else {
        playerSpan.textContent = PLAYERS[state.current];
        if (state.nextActive === null) {
          statusEl.innerHTML = `Spieler <span class="font-semibold" id="playerSpan">${PLAYERS[state.current]}</span> ist dran. Feldwahl: frei.`;
        } else {
          statusEl.innerHTML = `Spieler <span class="font-semibold" id="playerSpan">${PLAYERS[state.current]}</span> ist dran. Spiele im Großfeld <span class="font-semibold">${state.nextActive+1}</span>.`;
        }
      }
    }

    function resetGame() {
      state = initialState();
      refreshUI();
    }

    // Events
    resetBtn.addEventListener('click', resetGame);
    helpBtn.addEventListener('click', () => rulesDialog.showModal());

    // Init
    state = initialState();
    buildBoard();
  </script> -->
</body>

</html>
<!DOCTYPE html>
<html lang="de">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Ultimate Tic-Tac-Toe – Tailwind</title>
    <!-- Tailwind via CDN für Demo. In Produktion gern lokal einbinden. -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Sanfte Übergänge für Statusänderungen */
        .smooth {
            transition: all 180ms ease-in-out;
        }
    </style>
</head>

<body class="min-h-screen bg-[#12181B] text-slate-100 antialiased">
    <div class="mx-auto max-w-3xl px-4 py-8">
        <header class="mb-6 flex items-center justify-between">
            <h1 class="text-2xl md:text-3xl font-semibold tracking-tight">Ultimate Tic-Tac-Toe</h1>
            <h1>Lobby Code: {{ room_code }}</h1>
            <div class="flex gap-2">
                <button id="resetBtn"
                    class="rounded-xl bg-transparent border border-white/25 px-3 py-2 text-sm font-medium hover:bg-white/10 active:bg-white/15 smooth"
                    type="button">
                    Neu starten
                </button>
                <button id="helpBtn"
                    class="rounded-xl bg-transparent border border-white/25 px-3 py-2 text-sm font-medium hover:bg-white/10 active:bg-white/15 smooth"
                    type="button" onclick="document.getElementById('rulesDialog').showModal()">
                    Regeln
                </button>
            </div>
        </header>

        <!-- Players -->
        <div id="players" class="mb-5 rounded-xl bg-white/5 ring-1 ring-white/10 p-3 text-sm flex justify-between">
            <div id="player1">
                Du: <span id="symbol_you"></span>
            </div>

            <div id="status">
                Spieler <span class="font-semibold" id="playerSpan">X</span> ist dran.
            </div>

            <div id="player2">
                Gegner: <span id="symbol_oponent"></span>
            </div>
        </div>

        <!-- Statusleiste -->
        <!-- <div id="status" class="mb-5 rounded-xl bg-white/5 ring-1 ring-white/10 p-3 text-sm">
            Spieler <span class="font-semibold" id="playerSpan">X</span> ist dran.
        </div> -->

        <!-- Spielfeld: 3x3 Großfelder, jedes enthält ein 3x3 Kleinraster -->
        <!-- Spielfeld: 3x3 Großfelder, jedes enthält ein 3x3 Kleinraster -->
        <div id="board"
            class="mx-auto aspect-square w-full max-w-2xl grid grid-cols-3 gap-3 p-3 rounded-2xl bg-[#0F1518]/40 ring-1 ring-white/10 shadow-2xl backdrop-blur-sm">

            <!-- Großfeld 0 -->
            <div id="field_0"
                class="grid grid-cols-3 gap-1 aspect-square rounded-2xl p-1 bg-gradient-to-br from-[#1C2529] to-[#11171A] ring-2 ring-white shadow-xl">
                <div id="0_0" class="aspect-square rounded-lg border border-white/20 bg-[#2A3439] small-field">
                </div>
                <div id="0_1" class="aspect-square rounded-lg border border-white/20 bg-[#2A3439] small-field">
                </div>
                <div id="0_2" class="aspect-square rounded-lg border border-white/20 bg-[#2A3439] small-field">
                </div>
                <div id="0_3" class="aspect-square rounded-lg border border-white/20 bg-[#2A3439] small-field">
                </div>
                <div id="0_4" class="aspect-square rounded-lg border border-white/20 bg-[#2A3439] small-field">
                </div>
                <div id="0_5" class="aspect-square rounded-lg border border-white/20 bg-[#2A3439] small-field">
                </div>
                <div id="0_6" class="aspect-square rounded-lg border border-white/20 bg-[#2A3439] small-field">
                </div>
                <div id="0_7" class="aspect-square rounded-lg border border-white/20 bg-[#2A3439] small-field">
                </div>
                <div id="0_8" class="aspect-square rounded-lg border border-white/20 bg-[#2A3439] small-field">
                </div>
            </div>

            <!-- Großfeld 1 -->
            <div id="field_1"
                class="grid grid-cols-3 gap-1 aspect-square rounded-2xl p-1 bg-gradient-to-br from-[#1C2529] to-[#11171A] ring-2 ring-white shadow-xl">
                <div id="1_0" class="aspect-square rounded-lg border border-white/20 bg-[#2A3439] small-field">
                </div>
                <div id="1_1" class="aspect-square rounded-lg border border-white/20 bg-[#2A3439] small-field">
                </div>
                <div id="1_2" class="aspect-square rounded-lg border border-white/20 bg-[#2A3439] small-field">
                </div>
                <div id="1_3" class="aspect-square rounded-lg border border-white/20 bg-[#2A3439] small-field">
                </div>
                <div id="1_4" class="aspect-square rounded-lg border border-white/20 bg-[#2A3439] small-field">
                </div>
                <div id="1_5" class="aspect-square rounded-lg border border-white/20 bg-[#2A3439] small-field">
                </div>
                <div id="1_6" class="aspect-square rounded-lg border border-white/20 bg-[#2A3439] small-field">
                </div>
                <div id="1_7" class="aspect-square rounded-lg border border-white/20 bg-[#2A3439] small-field">
                </div>
                <div id="1_8" class="aspect-square rounded-lg border border-white/20 bg-[#2A3439] small-field">
                </div>
            </div>

            <!-- Großfeld 2 -->
            <div id="field_2"
                class="grid grid-cols-3 gap-1 aspect-square rounded-2xl p-1 bg-gradient-to-br from-[#1C2529] to-[#11171A] ring-2 ring-white shadow-xl">
                <div id="2_0" class="aspect-square rounded-lg border border-white/20 bg-[#2A3439] small-field">
                </div>
                <div id="2_1" class="aspect-square rounded-lg border border-white/20 bg-[#2A3439] small-field">
                </div>
                <div id="2_2" class="aspect-square rounded-lg border border-white/20 bg-[#2A3439] small-field">
                </div>
                <div id="2_3" class="aspect-square rounded-lg border border-white/20 bg-[#2A3439] small-field">
                </div>
                <div id="2_4" class="aspect-square rounded-lg border border-white/20 bg-[#2A3439] small-field">
                </div>
                <div id="2_5" class="aspect-square rounded-lg border border-white/20 bg-[#2A3439] small-field">
                </div>
                <div id="2_6" class="aspect-square rounded-lg border border-white/20 bg-[#2A3439] small-field">
                </div>
                <div id="2_7" class="aspect-square rounded-lg border border-white/20 bg-[#2A3439] small-field">
                </div>
                <div id="2_8" class="aspect-square rounded-lg border border-white/20 bg-[#2A3439] small-field">
                </div>
            </div>

            <!-- Großfeld 3 -->
            <div id="field_3"
                class="grid grid-cols-3 gap-1 aspect-square rounded-2xl p-1 bg-gradient-to-br from-[#1C2529] to-[#11171A] ring-2 ring-white shadow-xl">
                <div id="3_0" class="aspect-square rounded-lg border border-white/20 bg-[#2A3439] small-field">
                </div>
                <div id="3_1" class="aspect-square rounded-lg border border-white/20 bg-[#2A3439] small-field">
                </div>
                <div id="3_2" class="aspect-square rounded-lg border border-white/20 bg-[#2A3439] small-field">
                </div>
                <div id="3_3" class="aspect-square rounded-lg border border-white/20 bg-[#2A3439] small-field">
                </div>
                <div id="3_4" class="aspect-square rounded-lg border border-white/20 bg-[#2A3439] small-field">
                </div>
                <div id="3_5" class="aspect-square rounded-lg border border-white/20 bg-[#2A3439] small-field">
                </div>
                <div id="3_6" class="aspect-square rounded-lg border border-white/20 bg-[#2A3439] small-field">
                </div>
                <div id="3_7" class="aspect-square rounded-lg border border-white/20 bg-[#2A3439] small-field">
                </div>
                <div id="3_8" class="aspect-square rounded-lg border border-white/20 bg-[#2A3439] small-field">
                </div>
            </div>

            <!-- Großfeld 4 -->
            <div id="field_4"
                class="grid grid-cols-3 gap-1 aspect-square rounded-2xl p-1 bg-gradient-to-br from-[#1C2529] to-[#11171A] ring-2 ring-white shadow-xl">
                <div id="4_0" class="aspect-square rounded-lg border border-white/20 bg-[#2A3439] small-field">
                </div>
                <div id="4_1" class="aspect-square rounded-lg border border-white/20 bg-[#2A3439] small-field">
                </div>
                <div id="4_2" class="aspect-square rounded-lg border border-white/20 bg-[#2A3439] small-field">
                </div>
                <div id="4_3" class="aspect-square rounded-lg border border-white/20 bg-[#2A3439] small-field">
                </div>
                <div id="4_4" class="aspect-square rounded-lg border border-white/20 bg-[#2A3439] small-field">
                </div>
                <div id="4_5" class="aspect-square rounded-lg border border-white/20 bg-[#2A3439] small-field">
                </div>
                <div id="4_6" class="aspect-square rounded-lg border border-white/20 bg-[#2A3439] small-field">
                </div>
                <div id="4_7" class="aspect-square rounded-lg border border-white/20 bg-[#2A3439] small-field">
                </div>
                <div id="4_8" class="aspect-square rounded-lg border border-white/20 bg-[#2A3439] small-field">
                </div>
            </div>

            <!-- Großfeld 5 -->
            <div id="field_5"
                class="grid grid-cols-3 gap-1 aspect-square rounded-2xl p-1 bg-gradient-to-br from-[#1C2529] to-[#11171A] ring-2 ring-white shadow-xl">
                <div id="5_0" class="aspect-square rounded-lg border border-white/20 bg-[#2A3439] small-field">
                </div>
                <div id="5_1" class="aspect-square rounded-lg border border-white/20 bg-[#2A3439] small-field">
                </div>
                <div id="5_2" class="aspect-square rounded-lg border border-white/20 bg-[#2A3439] small-field">
                </div>
                <div id="5_3" class="aspect-square rounded-lg border border-white/20 bg-[#2A3439] small-field">
                </div>
                <div id="5_4" class="aspect-square rounded-lg border border-white/20 bg-[#2A3439] small-field">
                </div>
                <div id="5_5" class="aspect-square rounded-lg border border-white/20 bg-[#2A3439] small-field">
                </div>
                <div id="5_6" class="aspect-square rounded-lg border border-white/20 bg-[#2A3439] small-field">
                </div>
                <div id="5_7" class="aspect-square rounded-lg border border-white/20 bg-[#2A3439] small-field">
                </div>
                <div id="5_8" class="aspect-square rounded-lg border border-white/20 bg-[#2A3439] small-field">
                </div>
            </div>

            <!-- Großfeld 6 -->
            <div id="field_6"
                class="grid grid-cols-3 gap-1 aspect-square rounded-2xl p-1 bg-gradient-to-br from-[#1C2529] to-[#11171A] ring-2 ring-white shadow-xl">
                <div id="6_0" class="aspect-square rounded-lg border border-white/20 bg-[#2A3439] small-field">
                </div>
                <div id="6_1" class="aspect-square rounded-lg border border-white/20 bg-[#2A3439] small-field">
                </div>
                <div id="6_2" class="aspect-square rounded-lg border border-white/20 bg-[#2A3439] small-field">
                </div>
                <div id="6_3" class="aspect-square rounded-lg border border-white/20 bg-[#2A3439] small-field">
                </div>
                <div id="6_4" class="aspect-square rounded-lg border border-white/20 bg-[#2A3439] small-field">
                </div>
                <div id="6_5" class="aspect-square rounded-lg border border-white/20 bg-[#2A3439] small-field">
                </div>
                <div id="6_6" class="aspect-square rounded-lg border border-white/20 bg-[#2A3439] small-field">
                </div>
                <div id="6_7" class="aspect-square rounded-lg border border-white/20 bg-[#2A3439] small-field">
                </div>
                <div id="6_8" class="aspect-square rounded-lg border border-white/20 bg-[#2A3439] small-field">
                </div>
            </div>

            <!-- Großfeld 7 -->
            <div id="field_7"
                class="grid grid-cols-3 gap-1 aspect-square rounded-2xl p-1 bg-gradient-to-br from-[#1C2529] to-[#11171A] ring-2 ring-white shadow-xl">
                <div id="7_0" class="aspect-square rounded-lg border border-white/20 bg-[#2A3439] small-field">
                </div>
                <div id="7_1" class="aspect-square rounded-lg border border-white/20 bg-[#2A3439] small-field">
                </div>
                <div id="7_2" class="aspect-square rounded-lg border border-white/20 bg-[#2A3439] small-field">
                </div>
                <div id="7_3" class="aspect-square rounded-lg border border-white/20 bg-[#2A3439] small-field">
                </div>
                <div id="7_4" class="aspect-square rounded-lg border border-white/20 bg-[#2A3439] small-field">
                </div>
                <div id="7_5" class="aspect-square rounded-lg border border-white/20 bg-[#2A3439] small-field">
                </div>
                <div id="7_6" class="aspect-square rounded-lg border border-white/20 bg-[#2A3439] small-field">
                </div>
                <div id="7_7" class="aspect-square rounded-lg border border-white/20 bg-[#2A3439] small-field">
                </div>
                <div id="7_8" class="aspect-square rounded-lg border border-white/20 bg-[#2A3439] small-field">
                </div>
            </div>

            <!-- Großfeld 8 -->
            <div id="field_8"
                class="grid grid-cols-3 gap-1 aspect-square rounded-2xl p-1 bg-gradient-to-br from-[#1C2529] to-[#11171A] ring-2 ring-white shadow-xl">
                <div id="8_0" class="aspect-square rounded-lg border border-white/20 bg-[#2A3439] small-field">
                </div>
                <div id="8_1" class="aspect-square rounded-lg border border-white/20 bg-[#2A3439] small-field">
                </div>
                <div id="8_2" class="aspect-square rounded-lg border border-white/20 bg-[#2A3439] small-field">
                </div>
                <div id="8_3" class="aspect-square rounded-lg border border-white/20 bg-[#2A3439] small-field">
                </div>
                <div id="8_4" class="aspect-square rounded-lg border border-white/20 bg-[#2A3439] small-field">
                </div>
                <div id="8_5" class="aspect-square rounded-lg border border-white/20 bg-[#2A3439] small-field">
                </div>
                <div id="8_6" class="aspect-square rounded-lg border border-white/20 bg-[#2A3439] small-field">
                </div>
                <div id="8_7" class="aspect-square rounded-lg border border-white/20 bg-[#2A3439] small-field">
                </div>
                <div id="8_8" class="aspect-square rounded-lg border border-white/20 bg-[#2A3439] small-field">
                </div>
            </div>

        </div>

        <!-- Legende -->
        <div class="mt-6 grid gap-2 text-xs text-slate-300 md:grid-cols-3">
            <p><span class="inline-block h-3 w-3 align-middle rounded ring-2 ring-sky-400 mr-1"></span>Aktives Großfeld
            </p>
            <p><span
                    class="inline-block h-3 w-3 align-middle rounded bg-white/20 ring-1 ring-white/20 mr-1"></span>Inaktiv/gesperrt
            </p>
            <p><span
                    class="inline-block h-3 w-3 align-middle rounded bg-emerald-500/80 ring-1 ring-emerald-300/60 mr-1"></span>Gewonnenes
                Großfeld</p>
        </div>
    </div>

    <!-- Dialog -->
    <dialog id="rulesDialog"
      class="rounded-2xl bg-slate-900 text-slate-100 p-0 w-[min(92vw,32rem)]
            backdrop:bg-black/50 backdrop:backdrop-blur-sm">
      <div class="p-6 space-y-4">
        <h2 class="text-xl font-semibold">Kurz erklärt</h2>

        <div class="rounded-xl bg-white/5 ring-1 ring-white/10 p-4 max-h-[60vh] overflow-auto">
          <ol class="list-decimal pl-5 space-y-2 text-sm text-slate-300">
            <li>Das Spielfeld besteht aus 9 Großfeldern (3×3). Jedes Großfeld ist ein eigenes Tic-Tac-Toe (3×3).</li>
            <li>Dein Zug in einem Kleinfeld bestimmt, in welches Großfeld der/die Nächste setzen muss (Position 0–8).</li>
            <li>Ist dieses Großfeld bereits voll oder gewonnen, darf frei in einem beliebigen offenen Großfeld gesetzt werden.</li>
            <li>Ein Großfeld gilt als gewonnen, wenn darin eine 3er-Reihe erreicht wurde. Ziel ist 3 gewonnene Großfelder in einer Reihe.</li>
          </ol>
        </div>

        <div class="mt-2 flex justify-end">
          <button
            class="rounded-xl bg-transparent border border-white/25 px-3 py-2 text-sm font-medium hover:bg-white/10 smooth"
            onclick="this.closest('dialog').close()">
            Schließen
          </button>
        </div>
      </div>
    </dialog>



    <!-- Game-Over Modal -->
    <dialog id="gameOverDialog" class="rounded-2xl bg-slate-900 text-slate-100 p-0 w-[min(92vw,32rem)] backdrop:bg-black/50 backdrop:backdrop-blur-sm">
      <div class="p-6 space-y-4">
        <h2 class="text-xl font-semibold">Spiel beendet</h2>

        <div class="rounded-xl bg-white/5 ring-1 ring-white/10 p-4">
          <p class="text-sm text-slate-300">Sieger</p>
          <p id="go_winner" class="mt-1 text-2xl font-bold"></p>
        </div>

        <div class="grid grid-cols-2 gap-3">
          <div class="rounded-xl bg-white/5 ring-1 ring-white/10 p-3">
            <p class="text-xs text-slate-400">Spieler X</p>
            <p id="go_player_x" class="text-lg font-semibold">Unbekannt</p>
          </div>
          <div class="rounded-xl bg-white/5 ring-1 ring-white/10 p-3">
            <p class="text-xs text-slate-400">Spieler O</p>
            <p id="go_player_o" class="text-lg font-semibold">Unbekannt</p>
          </div>
        </div>

        <div class="mt-2 flex justify-end gap-2">
          <button id="go_quit_btn"
            class="rounded-xl bg-transparent border border-white/25 px-3 py-2 text-sm font-medium hover:bg-white/10 smooth"
            type="button">
            Beenden
          </button>
          <button id="go_restart_btn"
            class="rounded-xl bg-emerald-600/90 px-3 py-2 text-sm font-semibold hover:bg-emerald-600 smooth"
            type="button">
            Neustart
          </button>
        </div>
      </div>
    </dialog>

    {% include 'js.html' %}

    <script>
        // eine globale Referenz – nicht mehrfach als "let socket" deklarieren!
        window.socket = null;

        function wsBase() {
            return (location.protocol === "https:" ? "wss://" : "ws://") + location.host;
        }

        document.addEventListener("DOMContentLoaded", () => {
            const roomCode = "{{ room_code }}";                      // aus Django
            const nickname = localStorage.getItem("nickname") || "Spieler";

            // Falls schon was Offenes rumliegt, schließen (nur Vorsicht)
            if (window.socket && window.socket.readyState === WebSocket.OPEN) {
                try { window.socket.close(1000, "reconnect"); } catch (e) { }
            }

            // 1) Verbinden
            const url = `${wsBase()}/ws/game/${encodeURIComponent(roomCode)}/`;
            window.socket = new WebSocket(url);

            window.socket.addEventListener("open", () => {
                console.log("WS open (game page)");
                // 2) Im Raum anmelden
                window.socket.send(JSON.stringify({ action: "create_or_join", nickname }));
            });

            window.socket.addEventListener("message", (e) => {
                const msg = JSON.parse(e.data);
                console.log("WS msg (game page)", msg);

                if (msg.event === "joined") {
                    window.myId = msg.your_id;       // falls dein Server das mitsendet
                    window.mySymbol = msg.your_symbol;  // "X" oder "O"

                    const mySymbol = document.getElementById("symbol_you");
                    const oponentSymbol = document.getElementById("symbol_oponent");

                    if(msg.your_symbol == "X"){
                        mySymbol.classList.add('text-red-500')
                        mySymbol.innerText = msg.your_symbol

                       
                        oponentSymbol.classList.add('text-green-500')
                        oponentSymbol.innerText = "O"

                    }else{

                        mySymbol.classList.add('text-green-500')
                        mySymbol.innerText = msg.your_symbol
                        // Text im Status anpassen

                        oponentSymbol.classList.add('text-red-500')
                        oponentSymbol.innerText = "X"

                    }

                    const allSmalls = document.querySelectorAll(".small-field");

                    // über alle iterieren
                    allSmalls.forEach(el => {
                      el.classList.add("cursor-pointer", "hover:bg-[#37444A]");  // z. B. Mauszeiger aktivieren
                      // el.classList.remove("hover:bg-[#37444A]"); // Hover-Effekt entfernen
                    });

                    

                    // document.getElementById("symbol_oponent").innerText = msg.your_symbol ? "X" |"O"



                }

                if (msg.event === "move") {
                    window.currentPlayer = msg.currentPlayer; // "X" oder "O"
                    const allSmalls = document.querySelectorAll(".small-field");

                    console.log("CurrentPlayer", window.currentPlayer)
                    console.log("mySymbol", window.mySymbol)
                    

                    // if (window.currentPlayer && window.mySymbol && window.currentPlayer !== window.mySymbol) {
                    //     console.log("Nicht dein Zug.");
                    //     return;
                    // }

                  

                   // 1) überall Hover weg
                  // const allSmalls = document.querySelectorAll(".small-field");
                  allSmalls.forEach(el => el.classList.remove("cursor-pointer", "hover:bg-[#37444A]"));

                  // 2) Ziel-Großfeld & Status ermitteln
                  const targetBig = Number(msg.small);

                  // a) Ist Ziel per Server entschieden?
                  const decidedByServer = Array.isArray(msg.finished_fields) && msg.finished_fields.some(
                    f => Number(f.big) === targetBig && (f.winner === "X" || f.winner === "O" || f.winner === "D")
                  );

                  // b) Lokal voll?
                  const locallyFull = [...Array(9).keys()].every(i => {
                    const el = document.getElementById(`${targetBig}_${i}`);
                    return el && el.innerText.trim() !== "";
                  });

                  const isTargetClosed = decidedByServer || locallyFull;

                  // 3) Menge aller *geschlossenen* Großfelder bilden (gewonnen/Draw oder voll)
                  const closedBigs = new Set();
                  // aus Serverdaten
                  if (Array.isArray(msg.finished_fields)) {
                    msg.finished_fields.forEach(f => {
                      if (f && f.big != null && (f.winner === "X" || f.winner === "O" || f.winner === "D")) {
                        closedBigs.add(Number(f.big));
                      }
                    });
                  }
                  // lokal volle Großfelder ergänzen
                  for (let b = 0; b < 9; b++) {
                    const full = [...Array(9).keys()].every(i => {
                      const el = document.getElementById(`${b}_${i}`);
                      return el && el.innerText.trim() !== "";
                    });
                    if (full) closedBigs.add(b);
                  }

                  // 4) Hover setzen
                  if (isTargetClosed) {
                    // freie Wahl: nur leere Zellen in *offenen* Großfeldern
                    allSmalls.forEach(el => {
                      const [bStr] = el.id.split("_");
                      const b = Number(bStr);
                      const empty = el.innerText.trim() === "";
                      if (empty && !closedBigs.has(b)) {
                        el.classList.add("hover:bg-[#37444A]", "cursor-pointer");
                      }
                    });
                  } else {
                    // nur Ziel-Großfeld: leere Zellen aktivieren
                    for (let i = 0; i < 9; i++) {
                      const el = document.getElementById(`${targetBig}_${i}`);
                      if (el && el.innerText.trim() === "") {
                        el.classList.add("hover:bg-[#37444A]", "cursor-pointer");
                      }
                    }
                  }


                    // console.log("Ein zug auf Feld ", msg.big, msg.small);
                    // let id = msg.big + "_" + msg.small
                    

                    let field_to_click_id = "field_" + msg.small;
                    const next_big_field = document.getElementById(field_to_click_id);

                    let clicked_big_field_id = "field_" + msg.big;
                    const clicked_big_field = document.getElementById(clicked_big_field_id);

                    

                    // console.log("ID: ", id)
                    // console.log("MSG ", msg)
                    // console.log("Player ", msg.currentPlayer)

                    if(msg.currentPlayer == window.mySymbol){
                        document.getElementById("status").innerText = "Du bist am zug"
                    }else{
                        document.getElementById("status").innerText = `Der Spieler ${msg.currentPlayer} ist am zug`

                    }

                    const field = document.getElementById(`${msg.big}_${msg.small}`);

                    field.innerText = msg.symbol

                    if (msg.symbol == "X") {
                        field.classList.add(
                            'flex',
                            'items-center',
                            'justify-center',
                            'text-red-500',
                            'text-3xl',
                            'font-bold',
                            'border-2',          // Dicke Border
                            'border-red-500',    // Border-Farbe rot
                            'rounded-lg',        // Abgerundete Ecken
                            'shadow-lg',         // Starker Schatten
                            'shadow-red-500/50', // Rot getönter Glow
                            'transition',        // Sanfte Animation
                            'duration-300',      // Animationsdauer
                            // 'hover:scale-105',   // Leichtes Vergrößern beim Hover
                            'hover:shadow-red-400' // Hellere rote Glow-Farbe beim Hover
                        );
                    } else {
                        field.classList.add(
                            'flex',
                            'items-center',
                            'justify-center',
                            'text-green-500',
                            'text-3xl',
                            'font-bold',
                            'border-2',
                            'border-green-500',
                            'rounded-lg',
                            'shadow-lg',
                            'shadow-green-500/50',
                            'transition',
                            'duration-300',
                            // 'hover:scale-105',
                            'hover:shadow-green-400'
                        );
                    }

                    // clicked_big_field.classList.remove('ring-red-500', 'shadow-lg', 'shadow-red-500/50')
                    clicked_big_field.classList.add('ring-2', 'ring-white', 'shadow-xl')

                    next_big_field.classList.remove('ring-2', 'ring-white', 'shadow-xl');
                    next_big_field.classList.add('ring-2', 'ring-sky-400', 'shadow-lg', 'shadow-sky-400/50');

                    

                    // console.log("Results: " , msg.finished_fields)
                    if(msg.finished_fields){
                      for(i = 0; i < msg.finished_fields.length; i++){
                        const field_data = msg.finished_fields[i];
                        // console.log("Fielddata: ",field_data);
                        let field_id = "field_"

                        if(field_data["winner"] == "X"){
                          
                          const big_field = document.getElementById(`field_${field_data["big"]}`)
                          big_field.classList.add('ring-4','ring-red-500','shadow-lg','shadow-red-500/50');
                        }else if(field_data["winner"] == "O"){
                          const big_field = document.getElementById(`field_${field_data["big"]}`)
                          big_field.classList.add('ring-4','ring-green-500','shadow-lg','shadow-green-500/50');
                        }else{
                          const big_field = document.getElementById(`field_${field_data["big"]}`)
                          big_field.classList.add('ring-4','ring-gray-500','shadow-lg','shadow-gray-500/50');
                        }
                      }
                      
                    }
                    
                }

                if (msg.event === "game_over") {
                    // TODO: UI aktualisieren (Zug zeichnen etc.)
                    // console.log("Spiel zuende");
                    // console.log("Game_Over: ", msg)
                    const status = document.getElementById("status");
                    status.innerText = `Spieler ${msg.winner} hat das Spiel gewonnen`

                    // Sieger-Text
                    const winnerText =
                      msg.winner === "D" ? "Unentschieden" : `Spieler ${msg.winner} gewinnt!`;

                    document.getElementById("go_winner").innerText = winnerText;

                    // Spielernamen (falls du sie beim Join gesetzt hast)
                    document.getElementById("go_player_x").innerText = window.playerXName;
                    document.getElementById("go_player_o").innerText = window.playerOName;

                    // Modal öffnen
                    document.getElementById("gameOverDialog").showModal();
                  }

                if (msg.event === "reset") {
                  // Kleine Felder leeren & Klassen zurück auf Standard
                  document.querySelectorAll(".small-field").forEach(cell => {
                    cell.innerText = "";
                    cell.className = "aspect-square rounded-lg border border-white/20 bg-[#2A3439] small-field";
                  });

                  // Großfelder zurück auf Standard
                  for (let b = 0; b < 9; b++) {
                    const big = document.getElementById(`field_${b}`);
                    if (big) {
                      big.className = "grid grid-cols-3 gap-1 aspect-square rounded-2xl p-1 bg-gradient-to-br from-[#1C2529] to-[#11171A] ring-2 ring-white shadow-xl";
                    }
                  }

                  // Status/Turn zurücksetzen
                  window.currentPlayer = msg.currentPlayer || "X";
                  document.getElementById("status").innerText = "Spiel neugestartet. Spieler X beginnt.";

                  // Hover-Logik initial (freie Wahl)
                  document.querySelectorAll(".small-field").forEach(el => {
                    if (el.innerText.trim() === "") {
                      el.classList.add("hover:bg-[#37444A]", "cursor-pointer");
                    }
                  });

                  // Modal schließen, falls offen
                  const dlg = document.getElementById("gameOverDialog");
                  if (dlg && typeof dlg.close === "function") dlg.close();
                }

                  
                

                if (msg.event === "error") {
                    alert(msg.message || "Fehler");
                }
            });

            window.socket.addEventListener("close", () => console.log("WS closed (game page)"));
            window.socket.addEventListener("error", (e) => console.error("WS error", e));

            // Buttons
            document.getElementById("go_quit_btn").addEventListener("click", () => {
              // Beenden: zurück zur Übersicht o.ä.
              window.location.href = "/"; // passe an deine Route an
            });

            document.getElementById("go_restart_btn").addEventListener("click", () => {
              if (window.socket && window.socket.readyState === WebSocket.OPEN) {
                window.socket.send(JSON.stringify({ action: "reset" }));
              }
            });

            document.getElementById("resetBtn").addEventListener("click", () => {
              if (window.socket && window.socket.readyState === WebSocket.OPEN) {
                window.socket.send(JSON.stringify({ action: "reset" }));
              }
            });

            // 3) Klicks an die WS schicken – Event Delegation ist robust
            const board = document.getElementById("board");
            board.addEventListener("click", (ev) => {
                const cell = ev.target.closest("#board > div > div"); // deine kleinen Zellen
                if (!cell) return;

                // Indizes aus Position ableiten (oder setz dir data-Attribute im HTML)
                const allCells = [...document.querySelectorAll("#board > div > div")];
                const index = allCells.indexOf(cell);
                if (index < 0) return;

                const big = Math.floor(index / 9);
                const small = index % 9;

                if (!window.socket || window.socket.readyState !== WebSocket.OPEN) {
                    console.warn("WS nicht offen – move nicht gesendet");
                    return;
                }

                console.log(big, small)
                window.socket.send(JSON.stringify({
                    action: "game_move",
                    big,
                    small
                }));
            });
        });
        
    </script>

</body>

</html>